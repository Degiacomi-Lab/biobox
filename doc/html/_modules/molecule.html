
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>molecule &#8212; biobox 1.0 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">biobox 1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for molecule</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2014-2017 Matteo Degiacomi</span>
<span class="c1">#</span>
<span class="c1"># BiobOx is free software ;</span>
<span class="c1"># you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation ;</span>
<span class="c1"># either version 2 of the License, or (at your option) any later version.</span>
<span class="c1"># BiobOx is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY ;</span>
<span class="c1"># without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="c1"># See the GNU General Public License for more details.</span>
<span class="c1"># You should have received a copy of the GNU General Public License along with BiobOx ;</span>
<span class="c1"># if not, write to the Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA.</span>
<span class="c1">#</span>
<span class="c1"># Author : Matteo Degiacomi, matteothomas.degiacomi@gmail.com</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Definiton of constants for later calculations</span>
<span class="n">epsilon0</span> <span class="o">=</span> <span class="mf">8.8542</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span> <span class="c1"># m**-3 kg**-1 s**4 A**2, Permitivitty of free space</span>
<span class="n">kB</span> <span class="o">=</span> <span class="mf">1.3806</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">23</span><span class="p">)</span> <span class="c1"># m**2 kg s**-2 K-1, Lattice Boltzmann constant</span>
<span class="n">e</span> <span class="o">=</span> <span class="mf">1.602</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">19</span><span class="p">)</span> <span class="c1"># A s, electronic charge</span>
<span class="n">m</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">9</span><span class="p">)</span> <span class="c1"># number of nm in 1 m</span>
<span class="n">c</span> <span class="o">=</span> <span class="mf">3.336</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">30</span><span class="p">)</span> <span class="c1"># conversion from debye to e m</span>
<span class="n">Na</span> <span class="o">=</span> <span class="mf">6.022</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span> <span class="c1"># Avagadros Number</span>

<span class="kn">from</span> <span class="nn">biobox.classes.structure</span> <span class="k">import</span> <span class="n">Structure</span>
<span class="kn">from</span> <span class="nn">biobox.lib</span> <span class="k">import</span> <span class="n">e_density</span>

<div class="viewcode-block" id="Molecule"><a class="viewcode-back" href="../structure.html#molecule.Molecule">[docs]</a><span class="k">class</span> <span class="nc">Molecule</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Subclass of :func:`Structure &lt;structure.Structure&gt;`, allows reading, manipulating and analyzing molecular structures.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">chain_names</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        At instantiation, properties associated to every individual atoms are stored in a pandas Dataframe self.data.</span>
<span class="sd">        The columns of the self.data have the following names:</span>
<span class="sd">        atom, index, name, resname, chain, resid, beta, occupancy, atomtype, radius, charge.</span>

<span class="sd">        self.knowledge contains a knowledge base about atoms and residues properties. Default values are:</span>

<span class="sd">        * &#39;residue_mass&#39; property stores the average mass for most common aminoacids (values from Expasy website)</span>
<span class="sd">        * &#39;atom_vdw&#39; vdw radius of common atoms</span>
<span class="sd">        * &#39;atom_mass&#39; mass of common atoms</span>

<span class="sd">        The knowledge base can be edited. For instance, to add information about residue &quot;TST&quot; mass in molecule M type: M.knowledge[&#39;mass_residue&#39;][&quot;TST&quot;]=142.42</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Molecule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]))</span>

        <span class="c1"># knowledge base about atoms and residues properties (entry keys:</span>
        <span class="c1"># &#39;residue_mass&#39;, &#39;atom_vdw&#39;, &#39;atom_, mass&#39; can be edited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span><span class="p">[</span><span class="s1">&#39;residue_mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ALA&quot;</span><span class="p">:</span> <span class="mf">71.0788</span><span class="p">,</span> <span class="s2">&quot;ARG&quot;</span><span class="p">:</span> <span class="mf">156.1875</span><span class="p">,</span> <span class="s2">&quot;ASN&quot;</span><span class="p">:</span> <span class="mf">114.1038</span><span class="p">,</span> <span class="s2">&quot;ASP&quot;</span><span class="p">:</span> <span class="mf">115.0886</span><span class="p">,</span> <span class="s2">&quot;CYS&quot;</span><span class="p">:</span> <span class="mf">103.1388</span><span class="p">,</span> <span class="s2">&quot;CYX&quot;</span><span class="p">:</span> <span class="mf">103.1388</span><span class="p">,</span> <span class="s2">&quot;GLU&quot;</span><span class="p">:</span> <span class="mf">129.1155</span><span class="p">,</span> <span class="s2">&quot;GLN&quot;</span><span class="p">:</span> <span class="mf">128.1307</span><span class="p">,</span> <span class="s2">&quot;GLY&quot;</span><span class="p">:</span> <span class="mf">57.0519</span><span class="p">,</span>
                                          <span class="s2">&quot;HIS&quot;</span><span class="p">:</span> <span class="mf">137.1411</span><span class="p">,</span> <span class="s2">&quot;HSE&quot;</span><span class="p">:</span> <span class="mf">137.1411</span><span class="p">,</span> <span class="s2">&quot;HSD&quot;</span><span class="p">:</span> <span class="mf">137.1411</span><span class="p">,</span> <span class="s2">&quot;HSP&quot;</span><span class="p">:</span> <span class="mf">137.1411</span><span class="p">,</span> <span class="s2">&quot;HIE&quot;</span><span class="p">:</span> <span class="mf">137.1411</span><span class="p">,</span> <span class="s2">&quot;HID&quot;</span><span class="p">:</span> <span class="mf">137.1411</span><span class="p">,</span> <span class="s2">&quot;HIP&quot;</span><span class="p">:</span> <span class="mf">137.1411</span><span class="p">,</span> <span class="s2">&quot;ILE&quot;</span><span class="p">:</span> <span class="mf">113.1594</span><span class="p">,</span> <span class="s2">&quot;LEU&quot;</span><span class="p">:</span> <span class="mf">113.1594</span><span class="p">,</span>
                                          <span class="s2">&quot;LYS&quot;</span><span class="p">:</span> <span class="mf">128.1741</span><span class="p">,</span> <span class="s2">&quot;MET&quot;</span><span class="p">:</span> <span class="mf">131.1926</span><span class="p">,</span> <span class="s2">&quot;MSE&quot;</span><span class="p">:</span> <span class="mf">131.1926</span><span class="p">,</span> <span class="s2">&quot;PHE&quot;</span><span class="p">:</span> <span class="mf">147.1766</span><span class="p">,</span> <span class="s2">&quot;PRO&quot;</span><span class="p">:</span> <span class="mf">97.1167</span><span class="p">,</span> <span class="s2">&quot;SER&quot;</span><span class="p">:</span> <span class="mf">87.0782</span><span class="p">,</span> <span class="s2">&quot;THR&quot;</span><span class="p">:</span> <span class="mf">101.1051</span><span class="p">,</span> <span class="s2">&quot;TRP&quot;</span><span class="p">:</span> <span class="mf">186.2132</span><span class="p">,</span> <span class="s2">&quot;TYR&quot;</span><span class="p">:</span> <span class="mf">163.1760</span><span class="p">,</span> <span class="s2">&quot;VAL&quot;</span><span class="p">:</span> <span class="mf">99.1326</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span><span class="p">[</span><span class="s1">&#39;atom_vdw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mf">1.20</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mf">1.55</span><span class="p">,</span> <span class="s1">&#39;NA&#39;</span><span class="p">:</span> <span class="mf">2.27</span><span class="p">,</span> <span class="s1">&#39;CU&#39;</span><span class="p">:</span> <span class="mf">1.40</span><span class="p">,</span> <span class="s1">&#39;CL&#39;</span><span class="p">:</span> <span class="mf">1.75</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mf">1.70</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mf">1.52</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mf">1.98</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mf">1.80</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="mf">1.85</span><span class="p">,</span> <span class="s1">&#39;BR&#39;</span><span class="p">:</span> <span class="mf">1.85</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="mf">1.80</span><span class="p">,</span> <span class="s1">&#39;SE&#39;</span><span class="p">:</span> <span class="mf">1.90</span><span class="p">,</span>
                                      <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="mf">1.47</span><span class="p">,</span> <span class="s1">&#39;FE&#39;</span><span class="p">:</span> <span class="mf">1.80</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="mf">2.75</span><span class="p">,</span> <span class="s1">&#39;MN&#39;</span><span class="p">:</span> <span class="mf">1.73</span><span class="p">,</span> <span class="s1">&#39;MG&#39;</span><span class="p">:</span> <span class="mf">1.73</span><span class="p">,</span> <span class="s1">&#39;ZN&#39;</span><span class="p">:</span> <span class="mf">1.39</span><span class="p">,</span> <span class="s1">&#39;HG&#39;</span><span class="p">:</span> <span class="mf">1.8</span><span class="p">,</span> <span class="s1">&#39;XE&#39;</span><span class="p">:</span> <span class="mf">1.8</span><span class="p">,</span> <span class="s1">&#39;AU&#39;</span><span class="p">:</span> <span class="mf">1.8</span><span class="p">,</span> <span class="s1">&#39;LI&#39;</span><span class="p">:</span> <span class="mf">1.8</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span> <span class="mf">1.8</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span><span class="p">[</span><span class="s1">&#39;atom_ccs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mf">1.91</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mf">1.91</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="mf">1.91</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="mf">1.91</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="mf">1.91</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span> <span class="mf">1.91</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span><span class="p">[</span><span class="s1">&#39;atom_mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="mf">1.00794</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="mf">2.01410178</span><span class="p">,</span> <span class="s2">&quot;HE&quot;</span><span class="p">:</span> <span class="mf">4.00</span><span class="p">,</span> <span class="s2">&quot;LI&quot;</span><span class="p">:</span> <span class="mf">6.941</span><span class="p">,</span> <span class="s2">&quot;BE&quot;</span><span class="p">:</span> <span class="mf">9.01</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mf">10.811</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="mf">12.0107</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="mf">14.0067</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span><span class="p">:</span> <span class="mf">15.9994</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="mf">18.998403</span><span class="p">,</span> <span class="s2">&quot;NE&quot;</span><span class="p">:</span> <span class="mf">20.18</span><span class="p">,</span> <span class="s2">&quot;NA&quot;</span><span class="p">:</span> <span class="mf">22.989769</span><span class="p">,</span>
                                       <span class="s2">&quot;MG&quot;</span><span class="p">:</span> <span class="mf">24.305</span><span class="p">,</span> <span class="s2">&quot;AL&quot;</span><span class="p">:</span> <span class="mf">26.98</span><span class="p">,</span> <span class="s2">&quot;SI&quot;</span><span class="p">:</span> <span class="mf">28.09</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">:</span> <span class="mf">30.973762</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="mf">32.065</span><span class="p">,</span> <span class="s2">&quot;CL&quot;</span><span class="p">:</span> <span class="mf">35.453</span><span class="p">,</span> <span class="s2">&quot;AR&quot;</span><span class="p">:</span> <span class="mf">39.95</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="mf">39.0983</span><span class="p">,</span> <span class="s2">&quot;CA&quot;</span><span class="p">:</span> <span class="mf">40.078</span><span class="p">,</span> <span class="s2">&quot;SC&quot;</span><span class="p">:</span> <span class="mf">44.96</span><span class="p">,</span> <span class="s2">&quot;TI&quot;</span><span class="p">:</span> <span class="mf">47.87</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">:</span> <span class="mf">50.94</span><span class="p">,</span>
                                       <span class="s2">&quot;CR&quot;</span><span class="p">:</span> <span class="mf">51.9961</span><span class="p">,</span> <span class="s2">&quot;MN&quot;</span><span class="p">:</span> <span class="mf">54.938045</span><span class="p">,</span> <span class="s2">&quot;FE&quot;</span><span class="p">:</span> <span class="mf">55.845</span><span class="p">,</span> <span class="s2">&quot;CO&quot;</span><span class="p">:</span> <span class="mf">58.93</span><span class="p">,</span> <span class="s2">&quot;NI&quot;</span><span class="p">:</span> <span class="mf">58.6934</span><span class="p">,</span> <span class="s2">&quot;CU&quot;</span><span class="p">:</span> <span class="mf">63.546</span><span class="p">,</span> <span class="s2">&quot;ZN&quot;</span><span class="p">:</span> <span class="mf">65.409</span><span class="p">,</span> <span class="s2">&quot;GA&quot;</span><span class="p">:</span> <span class="mf">69.72</span><span class="p">,</span> <span class="s2">&quot;GE&quot;</span><span class="p">:</span> <span class="mf">72.64</span><span class="p">,</span> <span class="s2">&quot;AS&quot;</span><span class="p">:</span> <span class="mf">74.9216</span><span class="p">,</span> <span class="s2">&quot;SE&quot;</span><span class="p">:</span> <span class="mf">78.96</span><span class="p">,</span>
                                       <span class="s2">&quot;BR&quot;</span><span class="p">:</span> <span class="mf">79.90</span><span class="p">,</span> <span class="s2">&quot;KR&quot;</span><span class="p">:</span> <span class="mf">83.80</span><span class="p">,</span> <span class="s2">&quot;RB&quot;</span><span class="p">:</span> <span class="mf">85.47</span><span class="p">,</span> <span class="s2">&quot;SR&quot;</span><span class="p">:</span> <span class="mf">87.62</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="mf">88.91</span><span class="p">,</span> <span class="s2">&quot;ZR&quot;</span><span class="p">:</span> <span class="mf">91.22</span><span class="p">,</span> <span class="s2">&quot;NB&quot;</span><span class="p">:</span> <span class="mf">92.91</span><span class="p">,</span> <span class="s2">&quot;MO&quot;</span><span class="p">:</span> <span class="mf">95.94</span><span class="p">,</span> <span class="s2">&quot;TC&quot;</span><span class="p">:</span> <span class="mf">98.0</span><span class="p">,</span> <span class="s2">&quot;RU&quot;</span><span class="p">:</span> <span class="mf">101.07</span><span class="p">,</span> <span class="s2">&quot;RH&quot;</span><span class="p">:</span> <span class="mf">102.91</span><span class="p">,</span> <span class="s2">&quot;PD&quot;</span><span class="p">:</span> <span class="mf">106.42</span><span class="p">,</span>
                                       <span class="s2">&quot;AG&quot;</span><span class="p">:</span> <span class="mf">107.8682</span><span class="p">,</span> <span class="s2">&quot;CD&quot;</span><span class="p">:</span> <span class="mf">112.411</span><span class="p">,</span> <span class="s2">&quot;IN&quot;</span><span class="p">:</span> <span class="mf">114.82</span><span class="p">,</span> <span class="s2">&quot;SN&quot;</span><span class="p">:</span> <span class="mf">118.71</span><span class="p">,</span> <span class="s2">&quot;SB&quot;</span><span class="p">:</span> <span class="mf">121.76</span><span class="p">,</span> <span class="s2">&quot;TE&quot;</span><span class="p">:</span> <span class="mf">127.60</span><span class="p">,</span> <span class="s2">&quot;I&quot;</span><span class="p">:</span> <span class="mf">126.90447</span><span class="p">,</span> <span class="s2">&quot;XE&quot;</span><span class="p">:</span> <span class="mf">131.29</span><span class="p">,</span> <span class="s2">&quot;CS&quot;</span><span class="p">:</span> <span class="mf">132.91</span><span class="p">,</span> <span class="s2">&quot;BA&quot;</span><span class="p">:</span> <span class="mf">137.33</span><span class="p">,</span> <span class="s2">&quot;PR&quot;</span><span class="p">:</span> <span class="mf">140.91</span><span class="p">,</span>
                                       <span class="s2">&quot;EU&quot;</span><span class="p">:</span> <span class="mf">151.96</span><span class="p">,</span> <span class="s2">&quot;GD&quot;</span><span class="p">:</span> <span class="mf">157.25</span><span class="p">,</span> <span class="s2">&quot;TB&quot;</span><span class="p">:</span> <span class="mf">158.93</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="mf">183.84</span><span class="p">,</span> <span class="s2">&quot;IR&quot;</span><span class="p">:</span> <span class="mf">192.22</span><span class="p">,</span> <span class="s2">&quot;PT&quot;</span><span class="p">:</span> <span class="mf">195.084</span><span class="p">,</span> <span class="s2">&quot;AU&quot;</span><span class="p">:</span> <span class="mf">196.96657</span><span class="p">,</span> <span class="s2">&quot;HG&quot;</span><span class="p">:</span> <span class="mf">200.59</span><span class="p">,</span> <span class="s2">&quot;PB&quot;</span><span class="p">:</span> <span class="mf">207.2</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="mf">238.03</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span><span class="p">[</span><span class="s1">&#39;atomtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;CA&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;CB&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;CG1&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;CG2&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;CZ&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;CD1&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;CD2&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span>
                                      <span class="s2">&quot;CD&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;CE&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;CE1&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;CE2&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;CE3&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;CZ2&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;CZ3&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;CH2&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span>
                                      <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;NH1&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;NH2&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;NZ&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;NE&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;NE1&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;NE2&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;ND1&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;ND2&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span>
                                      <span class="s2">&quot;O&quot;</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;OG&quot;</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;OG1&quot;</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;OG2&quot;</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;OD1&quot;</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;OD2&quot;</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;OE1&quot;</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;OE2&quot;</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;OH&quot;</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;OXT&quot;</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span>
                                      <span class="s2">&quot;SD&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;SG&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HA&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HB1&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HB2&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HE1&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HE2&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HD1&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HD2&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> 
                                      <span class="s2">&quot;H1&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;H2&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;H3&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HH11&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HH12&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HH21&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HH22&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HG1&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HG2&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HE21&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> 
                                      <span class="s2">&quot;HE22&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HD11&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HD12&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HD13&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HD21&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HD22&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HG11&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HG12&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HG13&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> 
                                      <span class="s2">&quot;HG21&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HG22&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HG23&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HZ2&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HZ3&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HZ&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HA1&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HA2&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HB&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HD3&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> 
                                      <span class="s2">&quot;HG&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HZ1&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HE3&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HB3&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HH1&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HH2&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HD23&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HD13&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HE&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HH&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> 
                                      <span class="s2">&quot;OC1&quot;</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;OC2&quot;</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;OW&quot;</span><span class="p">:</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;HW1&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HW2&quot;</span><span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;CH3&quot;</span> <span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;HH31&quot;</span> <span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HH32&quot;</span> <span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;HH33&quot;</span> <span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span>
                                      <span class="s2">&quot;C00&quot;</span> <span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;C01&quot;</span> <span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;C02&quot;</span> <span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;C04&quot;</span> <span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;C06&quot;</span> <span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;C08&quot;</span> <span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;H03&quot;</span> <span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;H05&quot;</span> <span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;H07&quot;</span> <span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span>
                                      <span class="s2">&quot;H09&quot;</span> <span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;H0A&quot;</span> <span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;H0B&quot;</span> <span class="p">:</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">biobox.classes.multimer</span> <span class="k">import</span> <span class="n">Multimer</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">Multimer</span><span class="p">()</span>
        <span class="n">M</span><span class="o">.</span><span class="n">load_list</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">])</span>
        <span class="n">M2</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">make_molecule</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">M2</span>


<div class="viewcode-block" id="Molecule.know"><a class="viewcode-back" href="../structure.html#molecule.Molecule.know">[docs]</a>    <span class="k">def</span> <span class="nf">know</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        return information from knowledge base</span>

<span class="sd">        :param prop: desired property to extract from knowledge base</span>
<span class="sd">        :returns: value associated to requested property, or nan if failed</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">prop</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;entry </span><span class="si">%s</span><span class="s2"> not found in knowledge base!&quot;</span> <span class="o">%</span> <span class="n">prop</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.import_pdb"><a class="viewcode-back" href="../structure.html#molecule.Molecule.import_pdb">[docs]</a>    <span class="k">def</span> <span class="nf">import_pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdb</span><span class="p">,</span> <span class="n">include_hetatm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        read a pdb (possibly containing containing multiple models).</span>

<span class="sd">        Models are split according to ENDMDL and END statement.</span>
<span class="sd">        All alternative coordinates are expected to have the same atoms.</span>
<span class="sd">        After loading, the first model (M.current_model=0) will be set as active.</span>

<span class="sd">        :param pdb: PDB filename</span>
<span class="sd">        :param include_hetatm: if True, HETATM will be included (they get skipped if False)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">f_in</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdb</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: file </span><span class="si">%s</span><span class="s1"> not found!&#39;</span> <span class="o">%</span> <span class="n">pdb</span><span class="p">)</span>

        <span class="c1"># store filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdb</span>

        <span class="n">data_in</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">e</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">alternative</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">biomt</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">symm</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_in</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1"># load biomatrix, if any is present</span>
            <span class="k">if</span> <span class="s2">&quot;REMARK 350   BIOMT&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">biomt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: biomatrix format seems corrupted&quot;</span><span class="p">)</span>

            <span class="c1"># load symmetry matrix, if any is present</span>
            <span class="k">if</span> <span class="s2">&quot;REMARK 290   SMTRY&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">symm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: symmetry matrix format seems corrupted&quot;</span><span class="p">)</span>

            <span class="c1"># if a complete model was parsed store all the saved data into</span>
            <span class="c1"># self.data entries (if needed) and temporary alternative</span>
            <span class="c1"># coordinates list</span>
            <span class="k">if</span> <span class="n">record</span> <span class="o">==</span> <span class="s2">&quot;ENDMDL&quot;</span> <span class="ow">or</span> <span class="n">record</span> <span class="o">==</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                    <span class="c1"># load all the parsed data in superclass data (Dataframe)</span>
                    <span class="c1"># and points data structures</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1">#building dataframe</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_in</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;atom&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;resname&quot;</span><span class="p">,</span> <span class="s2">&quot;chain&quot;</span><span class="p">,</span> <span class="s2">&quot;resid&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;occupancy&quot;</span><span class="p">,</span> <span class="s2">&quot;atomtype&quot;</span><span class="p">]</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
                        <span class="c1"># Set the index numbers to the idx values to avoid hexadecimal counts</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>

                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: something went wrong when loading the structure </span><span class="si">%s</span><span class="s1">!</span><span class="se">\n</span><span class="s1">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span><span class="n">pdb</span><span class="p">)</span>

                    <span class="c1"># saving vdw radii</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: something went wrong when loading the structure </span><span class="si">%s</span><span class="s1">!</span><span class="se">\n</span><span class="s1">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span><span class="n">pdb</span><span class="p">)</span>

                    <span class="c1"># save default charge state</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

                <span class="c1"># save 3D coordinates of every atom and restart the accumulator</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">alternative</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: something went wrong when loading the structure </span><span class="si">%s</span><span class="s1">!</span><span class="se">\n</span><span class="s1">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span> <span class="n">pdb</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">record</span> <span class="o">==</span> <span class="s1">&#39;ATOM&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">include_hetatm</span> <span class="ow">and</span> <span class="n">record</span> <span class="o">==</span> <span class="s1">&#39;HETATM&#39;</span><span class="p">):</span>

                <span class="c1"># extract xyz coordinates (save in list of point coordinates)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">38</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">38</span><span class="p">:</span><span class="mi">46</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">46</span><span class="p">:</span><span class="mi">54</span><span class="p">])])</span>

                <span class="c1"># if no complete model has been yet parsed, load also</span>
                <span class="c1"># information about atoms(resid, resname, ...)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># extract ATOM/HETATM statement</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c1"># extract atom index</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c1"># extract atomname</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">21</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c1"># extract resname</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c1"># extract chain name</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">26</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c1"># extract residue id</span>

                    <span class="c1"># extract occupancy</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">54</span><span class="p">:</span><span class="mi">60</span><span class="p">]))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

                    <span class="c1"># extract beta factor</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># w.append(&quot;{0.2f}&quot;.format(float(line[60:66])))</span>
                        <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">60</span><span class="p">:</span><span class="mi">66</span><span class="p">]))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

                    <span class="c1"># extract atomtype</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">76</span><span class="p">:</span><span class="mi">78</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

                    <span class="c1"># use atomtype to extract vdw radius</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">know</span><span class="p">(</span><span class="s1">&#39;atom_vdw&#39;</span><span class="p">)[</span><span class="n">line</span><span class="p">[</span><span class="mi">76</span><span class="p">:</span><span class="mi">78</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()])</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">know</span><span class="p">(</span><span class="s1">&#39;atom_vdw&#39;</span><span class="p">)[</span><span class="s1">&#39;.&#39;</span><span class="p">])</span>

                    <span class="c1"># assign default charge state of 0</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

                    <span class="n">data_in</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="n">f_in</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># if p list is not empty, that means that the PDB file does not finish with an END statement (like the ones generated by SBT, for instance).</span>
        <span class="c1"># In this case, dump all the remaining stuff into alternate coordinates</span>
        <span class="c1"># array and (if needed) into properties dictionary.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c1"># if no model has been yet loaded, save also information in</span>
            <span class="c1"># properties dictionary.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                <span class="c1"># load all the parsed data in superclass properties[&#39;data&#39;] and</span>
                <span class="c1"># points data structures</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1">#building dataframe</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_in</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;atom&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;resname&quot;</span><span class="p">,</span> <span class="s2">&quot;chain&quot;</span><span class="p">,</span> <span class="s2">&quot;resid&quot;</span><span class="p">,</span> <span class="s2">&quot;occupancy&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;atomtype&quot;</span><span class="p">]</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
                    <span class="c1"># Set the index numbers to the idx values to avoid hexadecimal counts</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: something went wrong when saving data in </span><span class="si">%s</span><span class="s1">!</span><span class="se">\n</span><span class="s1">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span><span class="n">pdb</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: something went wrong when saving van der Waals radii in </span><span class="si">%s</span><span class="s1">!</span><span class="se">\n</span><span class="s1">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span> <span class="n">pdb</span><span class="p">)</span>

                <span class="c1"># save default charge state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="c1"># save 3D coordinates of every atom and restart the accumulator</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">alternative</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: something went wrong when saving coordinates in </span><span class="si">%s</span><span class="s1">!</span><span class="se">\n</span><span class="s1">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span><span class="n">pdb</span><span class="p">)</span>

        <span class="c1"># transform the alternative temporary list into a nice multiple</span>
        <span class="c1"># coordinates array</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">alternative_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">alternative_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">alternative</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: found </span><span class="si">%s</span><span class="s1"> models, but their atom count differs&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: treating only the first model in file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pdb</span><span class="p">)</span>
                <span class="c1">#raise Exception(&#39;ERROR: models appear not to have the same amount of atoms&#39;)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_xyz</span><span class="p">(</span><span class="n">alternative_xyz</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: something went wrong when saving alternative coordinates in </span><span class="si">%s</span><span class="s1">!</span><span class="se">\n</span><span class="s1">ERROR: no model was loaded... are ENDMDL statements there?&#39;</span> <span class="o">%</span> <span class="n">pdb</span><span class="p">)</span>

        <span class="c1"># if biomatrix information is provided, creat</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">biomt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c1"># test whether there are enough lines to create biomatrix</span>
            <span class="c1"># statements</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">biomt</span><span class="p">),</span> <span class="mi">3</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: found </span><span class="si">%s</span><span class="s1"> BIOMT entries. A multiple of 3 is expected&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">biomt</span><span class="p">))</span>

            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">biomt</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">biomt</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;biomatrix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>

        <span class="c1"># if symmetry information is provided, create entry in properties</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">symm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c1"># test whether there are enough lines to create biomatrix</span>
            <span class="c1"># statements</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symm</span><span class="p">),</span> <span class="mi">3</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: found </span><span class="si">%s</span><span class="s1"> SMTRY entries. A multiple of 3 is expected&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">symm</span><span class="p">))</span>

            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">symm</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">symm</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;symmetry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>

        <span class="c1">#correctly set types of columns requiring other than string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;occupancy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;occupancy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span></div>


<div class="viewcode-block" id="Molecule.import_pqr"><a class="viewcode-back" href="../structure.html#molecule.Molecule.import_pqr">[docs]</a>    <span class="k">def</span> <span class="nf">import_pqr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pqr</span><span class="p">,</span> <span class="n">include_hetatm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Read a pqr (possibly containing containing multiple models).</span>

<span class="sd">        models are split according to ENDMDL and END statement.</span>
<span class="sd">        All alternative coordinates are expected to have the same atoms.</span>
<span class="sd">        After loading, the first model (M.current_model=0) will be set as active.</span>

<span class="sd">        :param pqr: PQR filename</span>
<span class="sd">        :param include_hetatm: if True, HETATM will be included (they get skipped if False)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">f_in</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pqr</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: file </span><span class="si">%s</span><span class="s1"> not found!&#39;</span> <span class="o">%</span> <span class="n">pqr</span><span class="p">)</span>

        <span class="c1"># store filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pqr</span>

        <span class="n">data_in</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># collects coordinates for every model</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># vdW radii</span>
        <span class="n">e</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># electrostatics</span>
        <span class="n">alternative</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_in</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># if a complete model was parsed store all the saved data into</span>
            <span class="c1"># self.properties entries (if needed) and temporary alternative</span>
            <span class="c1"># coordinates list</span>
            <span class="k">if</span> <span class="n">record</span> <span class="o">==</span> <span class="s2">&quot;ENDMDL&quot;</span> <span class="ow">or</span> <span class="n">record</span> <span class="o">==</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># load all the parsed data in superclass properties[&#39;data&#39;]</span>
                    <span class="c1"># and points data structures</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1">#building dataframe</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_in</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;atom&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;resname&quot;</span><span class="p">,</span> <span class="s2">&quot;chain&quot;</span><span class="p">,</span> <span class="s2">&quot;resid&quot;</span><span class="p">,</span> <span class="s2">&quot;occupancy&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;atomtype&quot;</span><span class="p">]</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span> <span class="c1"># convert to internal numbering system</span>

                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: something went wrong when loading the structure </span><span class="si">%s</span><span class="s1">!</span><span class="se">\n</span><span class="s1">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span><span class="n">pqr</span><span class="p">)</span>

                    <span class="c1"># saving vdw radii</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: something went wrong when loading the structure </span><span class="si">%s</span><span class="s1">!</span><span class="se">\n</span><span class="s1">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span><span class="n">pqr</span><span class="p">)</span>

                    <span class="c1"># saving electrostatics</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: something went wrong when loading the structure </span><span class="si">%s</span><span class="s1">!</span><span class="se">\n</span><span class="s1">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span> <span class="n">pqr</span><span class="p">)</span>

                <span class="c1"># save 3D coordinates of every atom and restart the accumulator</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">alternative</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: something went wrong when loading the structure </span><span class="si">%s</span><span class="s1">!</span><span class="se">\n</span><span class="s1">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span><span class="n">pqr</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">record</span> <span class="o">==</span> <span class="s1">&#39;ATOM&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">include_hetatm</span> <span class="ow">and</span> <span class="n">record</span> <span class="o">==</span> <span class="s1">&#39;HETATM&#39;</span><span class="p">):</span>

                <span class="c1"># extract xyz coordinates (save in list of point coordinates)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">38</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">38</span><span class="p">:</span><span class="mi">46</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">46</span><span class="p">:</span><span class="mi">54</span><span class="p">])])</span>

                <span class="c1"># if no complete model has been yet parsed, load also</span>
                <span class="c1"># information about atoms(resid, resname, ...)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                    <span class="c1"># extract charge</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># 54 is separator, 55 is plus/minus</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">54</span><span class="p">:</span><span class="mi">62</span><span class="p">]))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

                    <span class="c1"># extract vdW radius</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">62</span><span class="p">:</span><span class="mi">69</span><span class="p">]))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">know</span><span class="p">(</span><span class="s1">&#39;atom_vdw&#39;</span><span class="p">)[</span><span class="s1">&#39;.&#39;</span><span class="p">])</span>

                    <span class="c1"># initialize list</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># extract ATOM/HETATM statement</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c1"># extract atom index</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c1"># extract atomname</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c1"># extract resname</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c1"># extract chain name</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">26</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c1"># extract residue id</span>

                    <span class="c1"># extract occupancy</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>

                    <span class="c1"># extract beta factor</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>

                    <span class="c1"># extract atomtype from atomname in BMRB notation</span>
                    <span class="c1"># http://www.bmrb.wisc.edu/ref_info/atom_nom.tbl</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="c1"># w.append(line[76:78].strip())</span>

                    <span class="n">data_in</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="n">f_in</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># if p list is not empty, that means that the pqr file does not finish with an END statement (like the ones generated by SBT, for instance).</span>
        <span class="c1"># In this case, dump all the remaining stuff into alternate coordinates</span>
        <span class="c1"># array and (if needed) into properties dictionary.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c1"># if no model has been yet loaded, save also information in</span>
            <span class="c1"># properties dictionary.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                <span class="c1"># load all the parsed data in superclass properties[&#39;data&#39;] and</span>
                <span class="c1"># points data structures</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1">#building dataframe</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_in</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;atom&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;resname&quot;</span><span class="p">,</span> <span class="s2">&quot;chain&quot;</span><span class="p">,</span> <span class="s2">&quot;resid&quot;</span><span class="p">,</span> <span class="s2">&quot;occupancy&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;atomtype&quot;</span><span class="p">]</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span> <span class="c1"># convert to internal numbering system</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: something went wrong when saving data in </span><span class="si">%s</span><span class="s1">!</span><span class="se">\n</span><span class="s1">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span> <span class="n">pqr</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: something went wrong when saving van der Waals radii in </span><span class="si">%s</span><span class="s1">!</span><span class="se">\n</span><span class="s1">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span><span class="n">pqr</span><span class="p">)</span>

            <span class="c1"># save 3D coordinates of every atom and restart the accumulator</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">alternative</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: something went wrong when saving coordinates in </span><span class="si">%s</span><span class="s1">!</span><span class="se">\n</span><span class="s1">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span><span class="n">pqr</span><span class="p">)</span>

        <span class="c1"># transform the alternative temporary list into a nice multiple</span>
        <span class="c1"># coordinates array</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">alternative_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">alternative_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">alternative</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: found </span><span class="si">%s</span><span class="s1"> models, but their atom count differs&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: treating only the first model in file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pqr</span><span class="p">)</span>
                <span class="c1">#raise Exception(&#39;ERROR: models appear not to have the same amount of atoms&#39;)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_xyz</span><span class="p">(</span><span class="n">alternative_xyz</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: something went wrong when saving alternative coordinates in </span><span class="si">%s</span><span class="s1">!</span><span class="se">\n</span><span class="s1">ERROR: no model was loaded... are ENDMDL statements there?&#39;</span> <span class="o">%</span> <span class="n">pqr</span><span class="p">)</span>

        <span class="c1">#correctly set types of columns requiring other than string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;occupancy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;occupancy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.assign_atomtype"><a class="viewcode-back" href="../structure.html#molecule.Molecule.assign_atomtype">[docs]</a>    <span class="k">def</span> <span class="nf">assign_atomtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        guess atomtype from atom names</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">a_type</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span><span class="p">[</span><span class="s2">&quot;atomtype&quot;</span><span class="p">][</span><span class="n">atom</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">a_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;atomtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_type</span></div>

<div class="viewcode-block" id="Molecule.get_vdw_density"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_vdw_density">[docs]</a>    <span class="k">def</span> <span class="nf">get_vdw_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">kernel_half_width</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        generate density map from points based on the van der Waals readius of the atoms</span>

<span class="sd">        :param buff: Buffer used to create the boundaries of the density map</span>
<span class="sd">        :param step: Stepsize for creating the density object</span>
<span class="sd">        :param kernel_half_width: Kernel half width of the gaussian kernel, will be scaled by atom specific sigma</span>
<span class="sd">        :returns: :func:`Density &lt;density.Density&gt;` object, containing a density map</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">atomdata</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">,</span> <span class="mf">1.455</span><span class="p">,</span> <span class="mf">0.51</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">0.72</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">],</span>
                    <span class="p">[</span><span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="mf">1.52</span><span class="p">,</span> <span class="mf">1.15</span><span class="p">,</span> <span class="mf">0.42</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">,</span> <span class="mf">1.62</span><span class="p">,</span> <span class="mf">0.54</span><span class="p">],</span>
                    <span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="mf">1.55</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">0.44</span><span class="p">]]</span>

        <span class="n">dens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">atomdata</span><span class="p">:</span>
            <span class="c1"># select atomtype and point only to those coordinates</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;atomtype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>

            <span class="c1"># if there are atoms from a certain type</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># use the standard density calculation with a atom-type</span>
                <span class="c1"># specific sigma value</span>
                <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density</span><span class="p">(</span><span class="n">buff</span><span class="o">=</span><span class="n">buff</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">kernel_half_width</span><span class="o">=</span><span class="n">kernel_half_width</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="c1"># export the np-array density map for summing</span>
                <span class="n">d_tmp</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;density&quot;</span><span class="p">]</span>

            <span class="c1"># print &#39;atom %s has a maximum density of %s, occurs %s times in the protein and the density map has a shape of %s&#39;%(d[0], np.max(d_tmp), len(pts), d_tmp.shape)</span>
            <span class="c1"># print &#39;one entry in d_tmp: \n%s&#39;%d_tmp[35][27][20]</span>
            <span class="c1"># print np.unravel_index(d_tmp.argmax(), d_tmp.shape)</span>
            <span class="c1"># initialize the dens-list if it&#39;s empty</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dens</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">d_tmp</span><span class="p">)</span>
            <span class="c1"># sum up the densities from all atom types</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dens</span> <span class="o">+=</span> <span class="n">d_tmp</span>  <span class="c1"># dens is a 3d numpy array with point intensities</span>

        <span class="c1"># print &#39;one entry in dens is: \n%s&#39;%dens[35][27][20]</span>

        <span class="kn">from</span> <span class="nn">biobox.classes.density</span> <span class="k">import</span> <span class="n">Density</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">Density</span><span class="p">()</span>
        <span class="n">D</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dens</span>
        <span class="n">D</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dens</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dens</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">D</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>
        <span class="n">D</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dx&#39;</span>
        <span class="n">D</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">D</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dens</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">D</span></div>

<div class="viewcode-block" id="Molecule.get_electrostatics"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_electrostatics">[docs]</a>    <span class="k">def</span> <span class="nf">get_electrostatics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">buff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">vdw_kernel_half_width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">elect_kernel_half_width</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">clear_mass</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        generate electrostatics map from points</span>

<span class="sd">        :param step: size of cubic voxels, in Angstrom</span>
<span class="sd">        :param buff: padding to add at points cloud boundaries</span>
<span class="sd">        :param threshold: Threshold used for removing mass occupied space from the electron density map</span>
<span class="sd">        :param vdw_kernel_half_width: kernel half width, in voxels</span>
<span class="sd">        :param elect_kernel_half_width: kernel half width, in voxels</span>
<span class="sd">        :param chain: select chain to use, default all chains</span>
<span class="sd">        :returns: positive :func:`Density &lt;density.Density&gt;` object</span>
<span class="sd">        :returns: negative :func:`Density &lt;density.Density&gt;` object</span>
<span class="sd">        :returns: mass density object</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">pts</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># numpy array of charges [c1, c2, c3, ...]</span>
            <span class="n">charges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: No charges associated with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>

        <span class="n">charges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">charges</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">charges</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># numpy 2d-array of shape (:, 4): [[x, y, z, charge], [x, y, z,</span>
        <span class="c1"># charge], ...]</span>
        <span class="n">c_atoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">pts</span><span class="p">,</span> <span class="n">charges</span><span class="p">))</span>

        <span class="n">k</span> <span class="o">=</span> <span class="mf">8.9875517873681764</span>  <span class="c1"># Coulomb&#39;s constant in nN</span>

        <span class="c1"># rectangular box boundaries</span>
        <span class="n">bnds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">buff</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">buff</span><span class="p">],</span>
                         <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">buff</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">buff</span><span class="p">],</span>
                         <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pts</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">buff</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pts</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">buff</span><span class="p">]])</span>

        <span class="n">xax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">yax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">zax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

        <span class="c1"># create empty box</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">xax</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">yax</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">zax</span><span class="p">)))</span>

        <span class="c1"># place Kronecker deltas in mesh grid -&gt; discretes point coordinates</span>
        <span class="c1"># into mesh grid with an intensity of charge</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">c_atoms</span><span class="p">:</span>
            <span class="n">xpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xax</span> <span class="o">-</span> <span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">ypos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yax</span> <span class="o">-</span> <span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">zpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zax</span> <span class="o">-</span> <span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">d</span><span class="p">[</span><span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">,</span> <span class="n">zpos</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># initialize 3d kernel_box</span>
        <span class="c1"># how many steps are needed to reach kernel half width in angstroms</span>
        <span class="n">l_kernel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">elect_kernel_half_width</span> <span class="o">/</span> <span class="n">step</span><span class="p">)</span>
        <span class="c1"># the kernel is an empty box...</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">l_kernel</span><span class="p">,</span> <span class="n">l_kernel</span><span class="p">,</span> <span class="n">l_kernel</span><span class="p">))</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nditer</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;multi_index&#39;</span><span class="p">])</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">it</span><span class="o">.</span><span class="n">finished</span><span class="p">:</span>
            <span class="n">x_index</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># indices</span>
            <span class="n">y_index</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">z_index</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">x_coord</span> <span class="o">=</span> <span class="n">x_index</span> <span class="o">*</span> <span class="n">step</span> <span class="o">-</span> <span class="p">(</span><span class="n">l_kernel</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># real space coordinates</span>
            <span class="n">y_coord</span> <span class="o">=</span> <span class="n">y_index</span> <span class="o">*</span> <span class="n">step</span> <span class="o">-</span> <span class="p">(</span><span class="n">l_kernel</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">z_coord</span> <span class="o">=</span> <span class="n">z_index</span> <span class="o">*</span> <span class="n">step</span> <span class="o">-</span> <span class="p">(</span><span class="n">l_kernel</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x_coord</span> <span class="o">*</span><span class="n">x_coord</span> <span class="o">+</span> <span class="n">y_coord</span> <span class="o">*</span><span class="n">y_coord</span> <span class="o">+</span> <span class="n">z_coord</span> <span class="o">*</span><span class="n">z_coord</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">distance</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>  <span class="c1"># ... where a hyperbola will be created only outside of H-vdW and inside of relevant kernel-half-width distance</span>
                <span class="n">kernel</span><span class="p">[</span><span class="n">x_index</span><span class="p">,</span> <span class="n">y_index</span><span class="p">,</span> <span class="n">z_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span> <span class="o">/</span> <span class="n">distance</span>

            <span class="n">it</span><span class="o">.</span><span class="n">iternext</span><span class="p">()</span>

        <span class="c1"># convolve point mesh with 3d coulomb hyperbola</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

        <span class="c1"># define mass-occupied space</span>
        <span class="c1"># mass_density is Density-object, buff=buff makes shure that the</span>
        <span class="c1"># density maps have the same dimensions</span>
        <span class="n">mass_density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vdw_density</span><span class="p">(</span>
            <span class="n">buff</span><span class="o">=</span><span class="n">buff</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">kernel_half_width</span><span class="o">=</span><span class="n">vdw_kernel_half_width</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">clear_mass</span><span class="p">:</span>
            <span class="n">d_map</span> <span class="o">=</span> <span class="n">mass_density</span><span class="o">.</span><span class="n">return_density_map</span><span class="p">()</span>

        <span class="c1"># initialize counter to count the amount of removed points</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># initialize the iterator for said function</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nditer</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;multi_index&#39;</span><span class="p">])</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">it</span><span class="o">.</span><span class="n">finished</span><span class="p">:</span>
            <span class="n">x_index</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># indices</span>
            <span class="n">y_index</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">z_index</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">x_coord</span> <span class="o">=</span> <span class="n">xax</span><span class="p">[</span><span class="n">x_index</span><span class="p">]</span>  <span class="c1"># real space coordinates</span>
            <span class="n">y_coord</span> <span class="o">=</span> <span class="n">yax</span><span class="p">[</span><span class="n">y_index</span><span class="p">]</span>
            <span class="n">z_coord</span> <span class="o">=</span> <span class="n">zax</span><span class="p">[</span><span class="n">z_index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">d_map</span><span class="p">[</span><span class="n">x_index</span><span class="p">,</span> <span class="n">y_index</span><span class="p">,</span> <span class="n">z_index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">e</span><span class="p">[</span><span class="n">x_index</span><span class="p">,</span> <span class="n">y_index</span><span class="p">,</span> <span class="n">z_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">it</span><span class="o">.</span><span class="n">iternext</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;removed </span><span class="si">%s</span><span class="s1"> points due to van der Waals clashing&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

        <span class="c1"># split the density into two maps</span>
        <span class="n">e_pos</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">e_neg</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">e_pos</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">e_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">e_neg</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">e_neg</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># changes sign of negative array for better visualization</span>
        <span class="n">e_neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">(</span><span class="n">e_neg</span><span class="p">)</span>

        <span class="c1"># prepare density data structure for both positive and negative maps at</span>
        <span class="c1"># once</span>
        <span class="kn">from</span> <span class="nn">biobox.classes.density</span> <span class="k">import</span> <span class="n">Density</span>
        <span class="n">D_pos</span> <span class="o">=</span> <span class="n">Density</span><span class="p">()</span>
        <span class="n">D_neg</span> <span class="o">=</span> <span class="n">Density</span><span class="p">()</span>
        <span class="n">D_pos</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_pos</span>
        <span class="n">D_neg</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_neg</span>
        <span class="n">D_pos</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D_neg</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">D_pos</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D_neg</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">D_pos</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D_neg</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>
        <span class="n">D_pos</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D_neg</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dx&#39;</span>
        <span class="n">D_pos</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D_neg</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">D_pos</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">e_pos</span><span class="p">)</span>
        <span class="n">D_neg</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">e_neg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">D_pos</span><span class="p">,</span> <span class="n">D_neg</span><span class="p">,</span> <span class="n">mass_density</span></div>

    <span class="k">def</span> <span class="nf">_apply_matrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mats</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        replicate molecule according to list of transformation matrices</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">xyzall</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#data = []</span>
        <span class="c1"># create new data entry (renumber indices, reassign chain name)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">])</span>

        <span class="c1"># replicate original coordinates applying transformations</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mats</span><span class="p">:</span>
            <span class="n">xyz2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">+</span> <span class="n">m</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># translate</span>
            <span class="n">xyz2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xyz2</span><span class="p">,</span> <span class="n">m</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># rotate</span>
            <span class="n">xyzall</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">xyz2</span><span class="p">)</span>  <span class="c1"># merge</span>

            <span class="c1">#assign a specific name to the new chain</span>
            <span class="c1">#newdata = deepcopy(self.data)</span>
            <span class="c1">#newdata[&quot;chain&quot;] = self.chain_names[cnt]</span>

            <span class="c1">#if cnt == 0:</span>
            <span class="c1">#    data = [newdata]</span>
            <span class="c1">#else:</span>
            <span class="c1">#    data.append(newdata)</span>

            <span class="n">data_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span>
                <span class="s2">&quot;atom&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;resname&quot;</span><span class="p">,</span> <span class="s2">&quot;chain&quot;</span><span class="p">,</span>
                <span class="s2">&quot;resid&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;occupancy&quot;</span><span class="p">,</span> <span class="s2">&quot;atomtype&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

            <span class="n">data_tmp</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_names</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">data_tmp</span><span class="p">))</span>

            <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># temporary vectorized hexadecimal maker, in case there are more than</span>
        <span class="c1"># 9999 atoms</span>
        <span class="k">def</span> <span class="nf">dohex</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">hex</span><span class="p">(</span><span class="n">number</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">vhex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">dohex</span><span class="p">)</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">vhex</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;atom&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;resname&quot;</span><span class="p">,</span> <span class="s2">&quot;chain&quot;</span><span class="p">,</span> <span class="s2">&quot;resid&quot;</span><span class="p">,</span> <span class="s2">&quot;occupancy&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;atomtype&quot;</span><span class="p">]</span>

        <span class="n">M2</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">()</span>
        <span class="n">M2</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xyzall</span><span class="p">])</span>
        <span class="n">M2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
        <span class="n">M2</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M2</span><span class="o">.</span><span class="n">get_center</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">M2</span>

<div class="viewcode-block" id="Molecule.apply_biomatrix"><a class="viewcode-back" href="../structure.html#molecule.Molecule.apply_biomatrix">[docs]</a>    <span class="k">def</span> <span class="nf">apply_biomatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        if biomatrix information is provided, generate a new molecule with all symmetry operators applied.</span>

<span class="sd">        :returns: new Molecule containing several copies of the current Molecule, arranged according to BIOMT statements contained in pdb, or -1 if no transformation matrix is provided</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># if no biomatrix statement is found, return with error</span>
        <span class="k">if</span> <span class="s2">&quot;biomatrix&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: no biomatrix found in pdb </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_matrices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;biomatrix&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Molecule.apply_symmetry"><a class="viewcode-back" href="../structure.html#molecule.Molecule.apply_symmetry">[docs]</a>    <span class="k">def</span> <span class="nf">apply_symmetry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        if symmetry information is provided, generate a new molecule with all symmetry operators applied.</span>

<span class="sd">        :returns: new Molecule containing several copies of the current Molecule, arranged according to SMTRY statements contained in pdb, or -1 if no transformation matrix is provided</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># if no symmetry statement is found, return with error</span>
        <span class="k">if</span> <span class="s2">&quot;symmetry&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: no symmetry matrix found in pdb </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_matrices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;symmetry&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Molecule.import_gro"><a class="viewcode-back" href="../structure.html#molecule.Molecule.import_gro">[docs]</a>    <span class="k">def</span> <span class="nf">import_gro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        read a gro possibly containing multiple structures.</span>

<span class="sd">        :param filename: name of .gro file to import</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: </span><span class="si">%s</span><span class="s2"> not found!&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># print &quot;\n&gt; loading %s...&quot;%filename</span>
        <span class="n">fin</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="n">d_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">atoms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fin</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
            <span class="n">d_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">atoms</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="c1"># Read array as defined by .gro style characters (res int, res, atomtype, int, x_coord, y_coord, z_coord) </span>
                <span class="n">w</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">w</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">w</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">15</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">w</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">w</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">28</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">w</span><span class="p">[</span><span class="mi">28</span><span class="p">:</span><span class="mi">36</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">w</span><span class="p">[</span><span class="mi">36</span><span class="p">:</span><span class="mi">44</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                <span class="n">resname</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">resnumber</span><span class="o">=</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># read data useful for indexing (guess what is missing)</span>
                <span class="n">d_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;ATOM&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">resname</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">resnumber</span><span class="p">,</span> <span class="s2">&quot;0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">])</span>
                <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="mi">6</span><span class="p">]])</span>
                <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># add one conformation (in Angstrom) and store its box size in</span>
            <span class="c1"># temporary list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_xyz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

            <span class="n">line</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>  <span class="c1"># attempt to get header of next frame</span>

        <span class="c1"># store data information and box size for every frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>


        <span class="c1">#building dataframe</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d_data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;atom&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;resname&quot;</span><span class="p">,</span> <span class="s2">&quot;chain&quot;</span><span class="p">,</span> <span class="s2">&quot;resid&quot;</span><span class="p">,</span> <span class="s2">&quot;occupancy&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;atomtype&quot;</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

        <span class="c1">#add additional information about van der waals radius and atoms charge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d_data</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">know</span><span class="p">(</span><span class="s1">&#39;atom_vdw&#39;</span><span class="p">)[</span><span class="s1">&#39;.&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d_data</span><span class="p">))</span>

        <span class="n">fin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="Molecule.get_atoms_ccs"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_atoms_ccs">[docs]</a>    <span class="k">def</span> <span class="nf">get_atoms_ccs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        return array with atomic CCS radii of every atom in molecule</span>

<span class="sd">        :returns: CCS in Angstrom^2</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="s2">&quot;atom_ccs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;atom_ccs&quot;</span><span class="p">]</span>

        <span class="n">ccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">know</span><span class="p">(</span><span class="s2">&quot;atom_ccs&quot;</span><span class="p">)[</span><span class="s2">&quot;.&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">know</span><span class="p">(</span><span class="s2">&quot;atom_ccs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;e&quot;</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                <span class="n">ccs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;atomtype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span><span class="p">[</span><span class="s2">&quot;atom_ccs&quot;</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;atom_ccs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ccs</span>

        <span class="k">return</span> <span class="n">ccs</span></div>

<div class="viewcode-block" id="Molecule.get_data"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="p">[],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return information about atoms of interest (i.e., slice the data DataFrame)</span>

<span class="sd">        :param indices: list of indices, if not provided all atom data is returned</span>
<span class="sd">        :param columns: list of columns (e.g. [&quot;resname&quot;, &quot;resid&quot;, &quot;chain&quot;]), if not provided all columns are returned</span>
<span class="sd">        :returns: numpy array containing a slice of molecule&#39;s data</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>   </div>


<div class="viewcode-block" id="Molecule.set_data"><a class="viewcode-back" href="../structure.html#molecule.Molecule.set_data">[docs]</a>    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="p">[],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return information about atoms of interest (i.e., slice the data DataFrame)</span>

<span class="sd">        :param indices: list of indices, if not provided all atom data is returned</span>
<span class="sd">        :param columns: list of columns (e.g. [&quot;resname&quot;, &quot;resid&quot;, &quot;chain&quot;]), if not provided all columns are returned</span>
<span class="sd">        :returns: numpy array containing a slice of molecule&#39;s data</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;indices, columns or both should be provided&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="Molecule.query"><a class="viewcode-back" href="../structure.html#molecule.Molecule.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_text</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Select specific atoms in a multimer un the basis of a text query.</span>

<span class="sd">        :param query_text: string selecting atoms of interest. Uses the pandas query syntax, can access all columns in the dataframe self.data.</span>
<span class="sd">        :param get_index: if set to True, returns the indices of selected atoms in self.points array (and self.data)</span>
<span class="sd">        :returns: coordinates of the selected points (in a unique array) and, if get_index is set to true, a list of their indices in subunits&#39; self.points array.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query_text</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="n">get_index</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></div>


<div class="viewcode-block" id="Molecule.atomselect"><a class="viewcode-back" href="../structure.html#molecule.Molecule.atomselect">[docs]</a>    <span class="k">def</span> <span class="nf">atomselect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_resname</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Select specific atoms in the protein providing chain, residue ID and atom name.</span>

<span class="sd">        :param chain: selection of a specific chain name (accepts * as wildcard). Can also be a list or numpy array of strings.</span>
<span class="sd">        :param res: residue ID of desired atoms (accepts * as wildcard). Can also be a list or numpy array of of int.</span>
<span class="sd">        :param atom: name of desired atom (accepts * as wildcard). Can also be a list or numpy array of strings.</span>
<span class="sd">        :param get_index: if set to True, returns the indices of selected atoms in self.points array (and self.data)</span>
<span class="sd">        :param use_resname: if set to True, consider information in &quot;res&quot; variable as resnames, and not resids</span>
<span class="sd">        :returns: coordinates of the selected points and, if get_index is set to true, their indices in self.points array.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># chain name boolean selector</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">chain</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                <span class="n">chain_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chain_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;chain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">chain</span>
                
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="n">chain_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;chain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">chain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">chain_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">chain_query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;chain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">chain</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: wrong type for chain selection. Should be str, list, or numpy&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                <span class="n">res_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">use_resname</span><span class="p">:</span>
                <span class="n">res_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">res</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">res</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">use_resname</span><span class="p">:</span>
                <span class="n">res_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">res</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_resname</span><span class="p">:</span>
                <span class="n">res_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">use_resname</span><span class="p">:</span>
                    <span class="n">res_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">res_query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">r</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">res_query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">res</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: wrong type for resid selection. Should be int, list, or numpy&quot;</span><span class="p">)</span>

        <span class="c1"># atom name boolean selector</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">atom</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                <span class="n">atom_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atom_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">atom</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s1">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="n">atom_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">atom_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">atom_query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">atom</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: wrong type for atom selection. Should be str, list, or numpy&quot;</span><span class="p">)</span>

        <span class="c1"># slice data array and return result (colums 5 to 7 contain xyz coords)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">chain_query</span><span class="p">,</span> <span class="n">res_query</span><span class="p">),</span> <span class="n">atom_query</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">get_index</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">query</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">query</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">query</span><span class="p">]</span></div>

<div class="viewcode-block" id="Molecule.atomignore"><a class="viewcode-back" href="../structure.html#molecule.Molecule.atomignore">[docs]</a>    <span class="k">def</span> <span class="nf">atomignore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_resname</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Select specific atoms that do not match a specific query (chain, residue ID and atom name).</span>
<span class="sd">        Useful to remove from a molecule atoms unwanted for further analysis, alternative conformations, etc...</span>

<span class="sd">        :param chain: chain name (accepts * as wildcard). Can also be a list or numpy array of strings.</span>
<span class="sd">        :param res: residue ID (accepts * as wildcard). Can also be a list or numpy array of of int.</span>
<span class="sd">        :param atom: atom name (accepts * as wildcard). Can also be a list or numpy array of strings.</span>
<span class="sd">        :param get_index: if set to True, returns the indices of atoms in self.points array (and self.data)</span>
<span class="sd">        :param use_resname: if set to True, consider information in &quot;res&quot; variable as resnames, and not resids</span>
<span class="sd">        :returns: coordinates of the selected points not matching the query, if get_index is set to true, their indices in self.points array.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1">#extract indices of atoms matching the query</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_resname</span><span class="o">=</span><span class="n">use_resname</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">#invert the selection</span>
        <span class="n">idxs2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
                <span class="n">idxs2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">get_index</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">idxs2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idxs2</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">idxs2</span><span class="p">]</span></div>

<div class="viewcode-block" id="Molecule.same_residue"><a class="viewcode-back" href="../structure.html#molecule.Molecule.same_residue">[docs]</a>    <span class="k">def</span> <span class="nf">same_residue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Select atoms having the same residue and chain as a given atom (or list of atoms)</span>

<span class="sd">        :param index indices: of atoms of choice (integer of list of integers)</span>
<span class="sd">        :param get_index: if set to True, returns the indices of selected atoms in self.points array (and self.data)</span>
<span class="sd">        :returns: coordinates of the selected points and, if get_index is set to true, their indices in self.points array.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>

        <span class="n">test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">D</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">l</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">D</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="n">l</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">])</span>

        <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">test</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">get_index</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pts</span><span class="p">,</span> <span class="n">idxs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pts</span></div>

<div class="viewcode-block" id="Molecule.same_residue_unique"><a class="viewcode-back" href="../structure.html#molecule.Molecule.same_residue_unique">[docs]</a>    <span class="k">def</span> <span class="nf">same_residue_unique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Select atoms having the same residue and chain as a given atom (or list of atoms)</span>

<span class="sd">        :param index: indices of atoms of choice (integer of list of integers)</span>
<span class="sd">        :param get_index: if set to True, returns the indices of selected atoms in self.points array (and self.data)</span>
<span class="sd">        :returns: coordinates of the selected points and, if get_index is set to true, their indices in self.points array.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">test</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>  <span class="c1"># this should fail if index is a number</span>
            <span class="n">idlist</span> <span class="o">=</span> <span class="n">index</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">idlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idlist</span><span class="p">:</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># starting from same point</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">-</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">elif</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="ow">and</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">-</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
                        <span class="n">pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">])</span>
                        <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">-</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
                        <span class="n">pts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>
                        <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>

                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">):</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">elif</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="ow">and</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
                        <span class="n">pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">])</span>
                        <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
                        <span class="n">pts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>
                        <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span>

                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">get_index</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.get_subset"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_subset">[docs]</a>    <span class="k">def</span> <span class="nf">get_subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">conformations</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a :func:`Molecule &lt;molecule.Molecule&gt;` object containing only the selected atoms and frames</span>

<span class="sd">        :param ixds: atoms to extract</span>
<span class="sd">        :param conformations: frames to extract (by default, all)</span>
<span class="sd">        :returns: :func:`Molecule &lt;molecule.Molecule&gt;` object</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># if a subset of all available frames is requested to be written,</span>
        <span class="c1"># select them first</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conformations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">frames</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">conformations</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">):</span>
                <span class="n">frames</span> <span class="o">=</span> <span class="n">conformations</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: requested coordinate index </span><span class="si">%s</span><span class="s2">, but only </span><span class="si">%s</span><span class="s2"> are available&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">conformations</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)))</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">))</span>

        <span class="c1"># create molecule, and push created data information</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">()</span>
        <span class="n">postmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[:,</span> <span class="n">idxs</span><span class="p">]</span>
        <span class="n">M</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">postmp</span><span class="p">[</span><span class="n">frames</span><span class="p">]</span>
        <span class="n">M</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>
        <span class="n">M</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">M</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="n">M</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">M</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">M</span><span class="o">.</span><span class="n">current</span><span class="p">]</span>

        <span class="n">M</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">get_center</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">M</span></div>

<div class="viewcode-block" id="Molecule.guess_chain_split"><a class="viewcode-back" href="../structure.html#molecule.Molecule.guess_chain_split">[docs]</a>    <span class="k">def</span> <span class="nf">guess_chain_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">use_backbone</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        reassign chain name, using distance cutoff (cannot be undone).</span>
<span class="sd">        If two consecutive atoms are beyond a cutoff, a new chain is assigned.</span>

<span class="sd">        :param distance: distance cutoff distanceR: no atomtype found!</span>

<span class="sd">        :param use_backbone: if True, splitting will be performed considering backbone atoms (N and C), all atoms in a sequence otherwise</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># wipe current chain assignment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;chain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># identify different chains</span>
        <span class="n">intervals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">gaps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_backbone</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="n">distance</span><span class="p">:</span>
                    <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#aminoacids start with N. Find where a C is too far from the next N.</span>
            <span class="n">posN</span><span class="p">,</span> <span class="n">idxN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">posC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">posN</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">posC</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;mismatch in N and C count&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idxN</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">posC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">posN</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">posC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">posN</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="n">distance</span><span class="p">:</span>
                    <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idxN</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">gaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

        <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># separate chains</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">thepos</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_names</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">intervals</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">intervals</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;chain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_names</span><span class="p">[</span><span class="n">thepos</span><span class="p">]</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">intervals</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gaps</span><span class="p">),</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.get_pdb_data"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_pdb_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_pdb_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        aggregate data and point coordinates, and return in a unique data structure</span>

<span class="sd">        Returned data is a list containing strings for points data and floats for point coordinates</span>
<span class="sd">        in the same order as a pdb file, i.e.</span>
<span class="sd">        ATOM/HETATM, index, name, resname, chain name, residue ID, x, y, z, occupancy, beta factor, atomtype.</span>

<span class="sd">        :returns: list aggregated data and coordinates for every point, as string.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># create a list containing all infos contained in pdb (point</span>
        <span class="c1"># coordinates and properties)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;atom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;chain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;occupancy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;atomtype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="Molecule.write_pdb"><a class="viewcode-back" href="../structure.html#molecule.Molecule.write_pdb">[docs]</a>    <span class="k">def</span> <span class="nf">write_pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">conformations</span><span class="o">=</span><span class="p">[],</span> <span class="n">index</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        overload superclass method for writing (multi)pdb.</span>

<span class="sd">        :param outname: name of pdb file to be generated.</span>
<span class="sd">        :param index: indices of atoms to write to file. If empty, all atoms are returned. Index values obtaineable with a call like: index=molecule.atomselect(&quot;A&quot;, [1, 2, 3], &quot;CA&quot;, True)[1]</span>
<span class="sd">        :param conformations: list of conformation indices to write to file. By default, a multipdb with all conformations will be produced.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># store current frame, so it will be reestablished after file output is</span>
        <span class="c1"># complete</span>
        <span class="n">currentbkp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span>

        <span class="c1"># if a subset of all available frames is requested to be written,</span>
        <span class="c1"># select them first</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conformations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">frames</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">conformations</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">):</span>
                <span class="n">frames</span> <span class="o">=</span> <span class="n">conformations</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: requested coordinate index </span><span class="si">%s</span><span class="s2">, but only </span><span class="si">%s</span><span class="s2"> are available&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">conformations</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)))</span>

        <span class="n">f_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
            <span class="c1"># get all informations from PDB (for current conformation) in a list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_current</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pdb_data</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            
            <span class="c1"># Build our hexidecimal array if num. of atoms &gt; 99999</span>
            <span class="n">idx_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">99999</span><span class="p">:</span>
                <span class="n">vhex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="nb">hex</span><span class="p">)</span>
                <span class="n">idx_val</span> <span class="o">=</span> <span class="n">vhex</span><span class="p">(</span><span class="n">idx_val</span><span class="p">)</span>   <span class="c1"># convert index values to hexidecimal</span>
                <span class="n">idx_val</span> <span class="o">=</span> <span class="p">[</span><span class="n">num</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">idx_val</span><span class="p">]</span>  <span class="c1"># remove 0x at start of hexidecimal number</span>
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># create and write PDB line</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">L</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%-6s%5s</span><span class="s1"> </span><span class="si">%-5s%-4s%1s%4s</span><span class="s1">    </span><span class="si">%8.3f%8.3f%8.3f%6.2f%6.2f</span><span class="s1">          </span><span class="si">%2s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx_val</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">6</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">7</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">8</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">9</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">10</span><span class="p">]),</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">11</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">L</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%-6s%5s</span><span class="s1">  </span><span class="si">%-4s%-4s%1s%4s</span><span class="s1">    </span><span class="si">%8.3f%8.3f%8.3f%6.2f%6.2f</span><span class="s1">          </span><span class="si">%2s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx_val</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">6</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">7</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">8</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">9</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">10</span><span class="p">]),</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">11</span><span class="p">])</span>
                <span class="n">f_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>

            <span class="n">f_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;END</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_current</span><span class="p">(</span><span class="n">currentbkp</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Molecule.write_gro"><a class="viewcode-back" href="../structure.html#molecule.Molecule.write_gro">[docs]</a>    <span class="k">def</span> <span class="nf">write_gro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">conformations</span><span class="o">=</span><span class="p">[],</span> <span class="n">index</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        write structure(s) in .gro format.</span>

<span class="sd">        :param outname: name of .gro file to be generated.</span>
<span class="sd">        :param index: indices of atoms to write to file. If empty, all atoms are returned. Index values obtaineable with a call like: index=molecule.atomselect(&quot;A&quot;, [1, 2, 3], &quot;CA&quot;, True)[1]</span>
<span class="sd">        :param conformations: list of conformation indices to write to file. By default, all conformations will be returned.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># store current frame, so it will be reestablished after file output is</span>
        <span class="c1"># complete</span>
        <span class="n">currentbkp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span>

        <span class="c1"># if a subset of all available frames is requested to be written,</span>
        <span class="c1"># select them first</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conformations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">frames</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">conformations</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">):</span>
                <span class="n">frames</span> <span class="o">=</span> <span class="n">conformations</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: requested coordinate index </span><span class="si">%s</span><span class="s2">, but only </span><span class="si">%s</span><span class="s2"> are available&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">conformations</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)))</span>

        <span class="n">f_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
            <span class="c1"># get all informations from PDB (for current conformation) in a</span>
            <span class="c1"># list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_current</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="c1"># ATOM/HETATM, index, atom name, resname, chain name, residue ID, x,</span>
            <span class="c1"># y, z, beta factor, occupancy, atomtype</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pdb_data</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">f_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">outname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">f_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># create and write .gro line</span>
                <span class="n">L</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%5d%-5s%5s%5d%8.3f%8.3f%8.3f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">]),</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">6</span><span class="p">])</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">7</span><span class="p">])</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">8</span><span class="p">])</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">)</span>
                <span class="n">f_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;box&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;box&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">/</span> <span class="mf">10.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">minpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">minpos</span> <span class="o">/</span> <span class="mf">10.0</span>

            <span class="n">formatting</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
                <span class="n">formatting</span><span class="o">+=</span><span class="s2">&quot;</span><span class="si">%10.5f</span><span class="s2">&quot;</span>
            <span class="n">formatting</span><span class="o">+=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="n">f_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">formatting</span><span class="o">%</span><span class="nb">tuple</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>

        <span class="n">f_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_current</span><span class="p">(</span><span class="n">currentbkp</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Molecule.beta_factor_from_rmsf"><a class="viewcode-back" href="../structure.html#molecule.Molecule.beta_factor_from_rmsf">[docs]</a>    <span class="k">def</span> <span class="nf">beta_factor_from_rmsf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        estimate atoms beta factor on the base of their RMSF.</span>

<span class="sd">        :param indices: indices of atoms of interest. If not set all atoms will be considered.</span>
<span class="sd">        :param step: timestep between two conformations (useful when using conformations extracted from molecular dynamics)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">rmsf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmsf</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
            <span class="k">return</span> <span class="mf">8.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rmsf</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: could not calculate RMSF!&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.rmsf_from_beta_factor"><a class="viewcode-back" href="../structure.html#molecule.Molecule.rmsf_from_beta_factor">[docs]</a>    <span class="k">def</span> <span class="nf">rmsf_from_beta_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        calculate RMSF from atoms beta factors.</span>

<span class="sd">        :param indices: indices of atoms of interest. If not set all atoms will be considered.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ERROR: beta factors missing?&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.get_mass_by_residue"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_mass_by_residue">[docs]</a>    <span class="k">def</span> <span class="nf">get_mass_by_residue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_resname</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute protein mass using residues (i.e. account also for atoms not present in the structure)</span>

<span class="sd">        Sum the average mass all every residue (using a knowledge base of atom masses in Dalton)</span>
<span class="sd">        The knowledge base can be expanded or edited by adding entries to the molecule&#39;s mass dictionary, e.g. to add the residue &quot;TST&quot; mass in molecule M type: M.knowledge[&#39;mass_residue&#39;][&quot;TST&quot;]=142.42</span>

<span class="sd">        :param skip_resname: list of resnames to skip. Useful to exclude ions water or other ligands from the calculation.</span>
<span class="sd">        :returns: mass of molecule in Dalton</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#@todo mass of N and C termini to add for every chain</span>

        <span class="n">mass</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">chains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;chain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chainname</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
            <span class="c1"># for every chain, get a list of all its (unique) resids</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="n">chainname</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">resids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;resid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">indices</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resids</span><span class="p">:</span>
                <span class="c1"># for every residue in the chain, get the index of its first</span>
                <span class="c1"># atom, and extract its associated resname</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="n">chainname</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">resname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;resname&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

                <span class="k">if</span> <span class="n">resname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip_resname</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># add mass of residue to total mass</span>
                        <span class="n">mass</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">know</span><span class="p">(</span><span class="s1">&#39;residue_mass&#39;</span><span class="p">)[</span><span class="n">resname</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="c1">#@todo: if residue is not known, why not summing constituent atoms masses, warning the user that it&#39;s an estimation?</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: mass for resname </span><span class="si">%s</span><span class="s2"> is unknown!</span><span class="se">\n</span><span class="s2">Insert a key in protein</span><span class="se">\&#39;</span><span class="s2">s masses dictionary knowledge[&#39;residue_mass&#39;] and retry!</span><span class="se">\n</span><span class="s2">ex.: protein.knowledge[&#39;residue_mass&#39;][</span><span class="se">\&quot;</span><span class="s2">TST</span><span class="se">\&quot;</span><span class="s2">]=142.42&quot;</span> <span class="o">%</span><span class="n">resname</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mass</span></div>

<div class="viewcode-block" id="Molecule.get_mass_by_atom"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_mass_by_atom">[docs]</a>    <span class="k">def</span> <span class="nf">get_mass_by_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_resname</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        compute protein mass using atoms in pdb</span>

<span class="sd">        sum the mass of all atoms (using a knowledge base of atom masses in Dalton)</span>
<span class="sd">        The knowledge base can be expanded or edited by adding or editing entries to the molecule&#39;s mass dictionary, e.g. to add the atom &quot;PI&quot; mass in molecule M type: M.knowledge[&#39;atom_mass&#39;][&quot;PI&quot;]=3.141592</span>

<span class="sd">        :param skip_resname: list of resnames to skip. Useful to exclude ions water or other ligands from the calculation.</span>
<span class="sd">        :returns: mass of molecule in Dalton</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">mass</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">resname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">atomtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;atomtype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">resname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip_resname</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mass</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">know</span><span class="p">(</span><span class="s1">&#39;atom_mass&#39;</span><span class="p">)[</span><span class="n">atomtype</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">atomtype</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="c1">#print(self.data.values[i:i+40])</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: no atomtype found!&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: mass for atom </span><span class="si">%s</span><span class="s2"> is unknown!</span><span class="se">\n</span><span class="s2">Insert a key in protein</span><span class="se">\&#39;</span><span class="s2">s masses dictionary knowledge[&#39;atom_mass&#39;] and retry!</span><span class="se">\n</span><span class="s2">ex.: protein.knowledge[&#39;atom_mass&#39;][</span><span class="se">\&quot;</span><span class="s2">PI</span><span class="se">\&quot;</span><span class="s2">]=3.141592&quot;</span> <span class="o">%</span><span class="n">atomtype</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mass</span></div>

<div class="viewcode-block" id="Molecule.s2"><a class="viewcode-back" href="../structure.html#molecule.Molecule.s2">[docs]</a>    <span class="k">def</span> <span class="nf">s2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atomname1</span><span class="o">=</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="n">atomname2</span><span class="o">=</span><span class="s2">&quot;H&quot;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        compute s2, given two atoms defining the vector of interest.</span>

<span class="sd">        :param atomname1: name of the first atom</span>
<span class="sd">        :param atomname2: name of the second atom</span>
<span class="sd">        :returns: data numpy array containing information about residues for which measuring has been performed (i.e.[chain, resid])</span>
<span class="sd">        :returns: s2 s2 of residues for which both provided input atoms have been found</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">Nidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">atomname1</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Hidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">atomname2</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Nidx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: no atom name </span><span class="si">%s</span><span class="s2"> found!&quot;</span><span class="o">%</span><span class="n">atomname1</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Hidx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: no atom name </span><span class="si">%s</span><span class="s2"> found!&quot;</span><span class="o">%</span><span class="n">atomname2</span><span class="p">)</span>

        <span class="n">Ndata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">Nidx</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;chain&quot;</span><span class="p">,</span> <span class="s2">&quot;resid&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">Hdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">Hidx</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;chain&quot;</span><span class="p">,</span> <span class="s2">&quot;resid&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">a1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ndata</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">Hdata</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">Ndata</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">Hdata</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">Ndata</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">idx1</span> <span class="o">=</span> <span class="n">Nidx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">idx2</span> <span class="o">=</span> <span class="n">Hidx</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">a1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[:,</span> <span class="n">idx1</span><span class="p">])</span>
                <span class="n">a2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[:,</span> <span class="n">idx2</span><span class="p">])</span>
                <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ndata</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">atoms1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
        <span class="n">atoms2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="c1"># iterate over every residue</span>
        <span class="n">s2_summary</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="n">dx</span> <span class="o">=</span> <span class="n">atoms2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">atoms1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">atoms2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">atoms1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="n">atoms2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">atoms1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span>

            <span class="c1"># create list of unit vectors</span>
            <span class="n">dnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">dx</span> <span class="o">/=</span> <span class="n">dnorm</span>
            <span class="n">dy</span> <span class="o">/=</span> <span class="n">dnorm</span>
            <span class="n">dz</span> <span class="o">/=</span> <span class="n">dnorm</span>

            <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span> <span class="o">/</span> <span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span> <span class="o">/</span> <span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dz</span><span class="p">)</span> <span class="o">/</span> <span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span> <span class="o">/</span> <span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span> <span class="o">/</span> <span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">dz</span><span class="p">)</span> <span class="o">/</span> <span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dz</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span> <span class="o">/</span> <span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dz</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span> <span class="o">/</span> <span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dz</span> <span class="o">*</span> <span class="n">dz</span><span class="p">)</span> <span class="o">/</span> <span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>

            <span class="n">s2_summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">s2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s2_summary</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">s2</span></div>


<div class="viewcode-block" id="Molecule.get_secondary_structure"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_secondary_structure">[docs]</a>    <span class="k">def</span> <span class="nf">get_secondary_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dssp_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        compute the protein&#39;s secondary structure, calling DSSP</span>
<span class="sd">        :param dssp_path: DSSP executable (path and filename). If not provided, the default behaviour is to seek for this information in the environment variable DSSPPATH</span>
<span class="sd">        :returns: numpy array of characters, with one-letter-coded secondary sctructure according to DSSP. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#dssp=&quot;~/bin/dssp-2.0.4-linux-amd64&quot;</span>
        <span class="k">if</span> <span class="n">dssp_path</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dssp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DSSPPATH&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;DSSPPATH environment variable undefined&quot;</span><span class="p">)</span>

        <span class="c1"># generate temporary PDB and calculate secondary structure using DSSP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_pdb</span><span class="p">(</span><span class="s2">&quot;tmp.pdb&quot;</span><span class="p">,</span> <span class="n">conformations</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">])</span> 

        <span class="c1">#TMP: assign all atoms to structure</span>
        <span class="c1">#subprocess.check_call(&#39;~/bin/amber16_tmp/bin/tleap -f build &gt; /dev/null&#39;, shell=True)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">subprocess</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -i tmp.pdb -o result.dssp&quot;</span><span class="o">%</span><span class="n">dssp_path</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">fin</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;result.dssp&quot;</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not calculate secondary structure! </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">e</span><span class="p">)</span>

        <span class="n">readit</span><span class="o">=</span><span class="kc">False</span>
        <span class="n">secstruct</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">readit</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ss</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
                        <span class="n">ss</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>

                    <span class="n">secstruct</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="s2">&quot;#&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">readit</span><span class="o">=</span><span class="kc">True</span>

        <span class="n">fin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># clean temporary files</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;result.dssp&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;tmp.pdb&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">secstruct</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">210</span><span class="p">])</span></div>
        

<div class="viewcode-block" id="Molecule.get_couples"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_couples">[docs]</a>    <span class="k">def</span> <span class="nf">get_couples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        given a list of indices, compute the all-vs-all distance and return only couples below a given cutoff distance</span>

<span class="sd">        useful for the detection of disulfide bridges or linkable sites via cross-linking (approximation, supposing euclidean distances)&#39;</span>

<span class="sd">        :param idx: indices of atoms to check.</span>
<span class="sd">        :param cutoff: minimal distance to consider a couple as linkable.</span>
<span class="sd">        :returns: nx3 numpy array containing, for every valid connection, id of first atom, id of second atom and distance between the two.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="kn">import</span> <span class="nn">biobox.measures.interaction</span> <span class="k">as</span> <span class="nn">I</span>

        <span class="n">points1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">distance_matrix</span><span class="p">(</span><span class="n">points1</span><span class="p">,</span> <span class="n">points1</span><span class="p">)</span>
        <span class="n">couples</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_neighbors</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">couples</span><span class="o">.</span><span class="n">transpose</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">idx</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">idx</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dist</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Molecule.match_residue"><a class="viewcode-back" href="../structure.html#molecule.Molecule.match_residue">[docs]</a>    <span class="k">def</span> <span class="nf">match_residue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">sec</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compares two bb.Molecule() peptide strands and returns the resids within both peptides when the two are homogenous</span>
<span class="sd">        beyond a certain secondary structure threashold. The default is 5 amino acids (given by sec) in a row must be identical</span>

<span class="sd">        Useful when aligning PDB structures that have been crystallised separately - so one may be missing the odd residue</span>
<span class="sd">        or have a few extra at the end.</span>

<span class="sd">        :param M2: The second bb.Molecule() to compare with</span>
<span class="sd">        :param sec: Number of consecutive amino acids in a row that must match before resid&#39;s are recorded</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Get residue names / unique IDs</span>
        <span class="n">M1_reslist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">M2_reslist</span> <span class="o">=</span> <span class="n">M2</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">][</span><span class="n">M2</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">M1_resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">M2_resid</span> <span class="o">=</span> <span class="n">M2</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">][</span><span class="n">M2</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Remove C or N prefixes</span>
        <span class="k">for</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">M1_reslist</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">M1_reslist</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">for</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">M2_reslist</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">M2_reslist</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="c1"># Rename residues temporararily so they match better</span>
        <span class="n">M1_reslist</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">M1_reslist</span> <span class="o">==</span> <span class="s1">&#39;HIE&#39;</span><span class="p">,</span> <span class="n">M1_reslist</span> <span class="o">==</span> <span class="s1">&#39;HIP&#39;</span><span class="p">),</span> <span class="n">M1_reslist</span> <span class="o">==</span> <span class="s1">&#39;HID&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;HIS&#39;</span>
        <span class="n">M2_reslist</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">M2_reslist</span> <span class="o">==</span> <span class="s1">&#39;HIE&#39;</span><span class="p">,</span> <span class="n">M2_reslist</span> <span class="o">==</span> <span class="s1">&#39;HIP&#39;</span><span class="p">),</span> <span class="n">M2_reslist</span> <span class="o">==</span> <span class="s1">&#39;HID&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;HIS&#39;</span>
        
        <span class="n">M1_reskeep</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">M2_reskeep</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">M2_cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">M1_cnt</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="n">M1_cnt</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">M1_reslist</span><span class="p">):</span>

            <span class="c1"># Initial check to see if we have a run of good matches (more than coincidence)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">M1_reslist</span><span class="p">[</span><span class="n">M1_cnt</span><span class="p">:(</span><span class="n">M1_cnt</span> <span class="o">+</span> <span class="n">sec</span><span class="p">)]</span> <span class="o">==</span> <span class="n">M2_reslist</span><span class="p">[</span><span class="n">M2_cnt</span><span class="p">:(</span><span class="n">M2_cnt</span> <span class="o">+</span> <span class="n">sec</span><span class="p">)]):</span>
        
                <span class="k">while</span> <span class="n">M1_reslist</span><span class="p">[</span><span class="n">M1_cnt</span><span class="p">]</span> <span class="o">==</span> <span class="n">M2_reslist</span><span class="p">[</span><span class="n">M2_cnt</span><span class="p">]:</span>

                    <span class="n">M1_reskeep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M1_resid</span><span class="p">[</span><span class="n">M1_cnt</span><span class="p">])</span>
                    <span class="n">M2_reskeep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">M2_resid</span><span class="p">[</span><span class="n">M2_cnt</span><span class="p">])</span>

                    <span class="n">M2_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">M1_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                    <span class="c1"># Break if we reach the maximum array length limit</span>
                    <span class="k">if</span> <span class="n">M1_cnt</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">M1_reslist</span><span class="p">)</span> <span class="ow">or</span> <span class="n">M2_cnt</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">M2_reslist</span><span class="p">):</span>
                        <span class="k">break</span>

                    <span class="c1"># Check if we conicidently had the correct corresponding resnames</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">M1_reskeep</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">M1_reskeep</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">M1_reskeep</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">M2_reskeep</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">M2_reskeep</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">M1_reskeep</span> <span class="o">=</span> <span class="n">M1_reskeep</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">M2_reskeep</span> <span class="o">=</span> <span class="n">M2_reskeep</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">break</span>
                        <span class="k">elif</span> <span class="n">M1_reskeep</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">M1_reskeep</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">M2_reskeep</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">M2_reskeep</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">M1_reskeep</span> <span class="o">=</span> <span class="n">M1_reskeep</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">M2_reskeep</span> <span class="o">=</span> <span class="n">M2_reskeep</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">continue</span>
        
            <span class="c1"># Elsewise move forward in count on second structure</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">M2_cnt</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Break if M1 and M2 have reached their ends, restart if only M2 has</span>
            <span class="k">if</span> <span class="n">M1_cnt</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">M1_reslist</span><span class="p">):</span> <span class="c1">#and M2_cnt == len(M2_reslist):</span>
                <span class="k">break</span>
            <span class="c1"># Need case so we don&#39;t recount a chain in the event of a homodimer</span>
            <span class="k">elif</span> <span class="n">M2_cnt</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">M2_reslist</span><span class="p">):</span>
                <span class="n">M1_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">M2_cnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">M1_reskeep</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="k">return</span> <span class="n">M1_reskeep</span><span class="p">,</span> <span class="n">M2_reskeep</span></div>

<div class="viewcode-block" id="Molecule.pdb2pqr"><a class="viewcode-back" href="../structure.html#molecule.Molecule.pdb2pqr">[docs]</a>    <span class="k">def</span> <span class="nf">pdb2pqr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ff</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Parses data from the pdb input into a pqr format. This uses the panda dataframe with the information</span>
<span class="sd">        regarding atom indexes, types etc. in the self.data files.</span>
<span class="sd">        It outputs a panda dataframe with the pqr equivilent information. It requires a datafile forcefield input.</span>
<span class="sd">        The default is the amber14sb forcefield file held within the classes/ folder.</span>
<span class="sd">        </span>
<span class="sd">        :param ff: name of forcefield text file input that needs to be read to read charges / vdw radii.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">intervals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guess_chain_split</span><span class="p">()</span>     
        <span class="c1"># patch naming of C-termini</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">same_residue</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>   
            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idxs</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">names</span> <span class="o">==</span> <span class="s2">&quot;OC1&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">names</span> <span class="o">==</span> <span class="s2">&quot;OXT&quot;</span><span class="p">):</span>
                <span class="n">resname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">newresnames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;C&quot;</span><span class="o">+</span><span class="n">resname</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idxs</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">newresnames</span>

        <span class="c1"># patch naming of N-termini</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">same_residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>   
            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idxs</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">names</span> <span class="o">==</span> <span class="s2">&quot;H1&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">names</span> <span class="o">==</span> <span class="s2">&quot;H2&quot;</span><span class="p">):</span>
                <span class="n">resname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">newresnames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;N&quot;</span><span class="o">+</span><span class="n">resname</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idxs</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">newresnames</span>



        <span class="n">HIP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;HIP&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">18</span><span class="p">)</span>    <span class="c1"># create numpy array structures to possibly reassign later</span>
        <span class="n">HIE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;HIE&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">17</span><span class="p">)</span>    <span class="c1"># create numpy array structures to possibly reassign later</span>
        <span class="n">HID</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;HID&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">17</span><span class="p">)</span>    <span class="c1"># create numpy array structures to possibly reassign later</span>
        <span class="n">NHIP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;NHIP&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
        <span class="n">NHIE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;NHIE&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">19</span><span class="p">)</span>
        <span class="n">NHID</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;NHID&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">19</span><span class="p">)</span>

        <span class="n">start_chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="c1"># This is in case we get 1 or 2 as the first chain ID start</span>
        <span class="n">end_chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>    <span class="c1">#  We don&#39;t know the end chain number so we find it here</span>
        <span class="n">start_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">end_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
        
        <span class="c1"># Need to check if first residue is actually an N-termini residue, and if so, reassign resnames if necessary</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">27</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;H1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">27</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;H2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">27</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;H3&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found N-Termini, reassigning first resname to match the forcefield&#39;</span><span class="p">)</span>
            <span class="n">start_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">start_chain</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="n">start_index</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span> <span class="o">+</span> <span class="n">start_res</span>   <span class="c1"># First chain needs to be prefixed with N-termini resname</span>
     
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1">#&quot;amber14sb.dat&quot;</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
            <span class="n">ff</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/amber14sb.dat&quot;</span> <span class="o">%</span> <span class="n">folder</span>
            
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: </span><span class="si">%s</span><span class="s2"> not found!&quot;</span> <span class="o">%</span> <span class="n">ff</span><span class="p">)</span>
        
        <span class="n">ff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
                        
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;resname&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;charge&#39;</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="s1">&#39;atomtype&#39;</span><span class="p">]</span> <span class="c1"># where radius is the VdW radius in the amber file</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ff</span><span class="p">))</span>
        <span class="n">pqr_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
    
        <span class="n">charges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atomtypes</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Need to check whether it matches HIE, HID or HIP depending on what protons are present and where</span>
        <span class="n">his_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HIS&#39;</span>  <span class="c1"># Check if we need to do following calculation</span>
        <span class="n">nhis_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NHIS&#39;</span> <span class="c1"># Check for N termini HIS</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">his_check</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nhis_check</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: found residue with name HIS, checking to see what protonation state it is in and reassigning to HIP, HIE or HID.</span><span class="se">\n</span><span class="s2">You should check HIS in your pdb file is right to be sure!&quot;</span><span class="p">)</span>     
            <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">])):</span>
                <span class="n">H_length</span> <span class="o">=</span> <span class="mi">17</span> <span class="c1"># Set this as it is more common, and also covers the basis to capture HD1 or HE2 later if necessary (as C and O tend to be last a</span>
                <span class="c1"># N is always the first atom (use that as basis)                                                                                                                             </span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="n">ix</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">][</span><span class="n">ix</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HIS&#39;</span><span class="p">:</span>  
                                                                                       
                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="n">ix</span><span class="p">:(</span><span class="n">ix</span><span class="o">+</span><span class="n">H_length</span><span class="p">)]</span> <span class="o">==</span> <span class="s1">&#39;HE2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="n">ix</span><span class="p">:(</span><span class="n">ix</span><span class="o">+</span><span class="n">H_length</span><span class="p">)]</span> <span class="o">==</span> <span class="s1">&#39;HD1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span> <span class="c1"># If the residue contains HE2 and HD1, it is a HIP residue</span>
                        <span class="n">H_length</span> <span class="o">=</span> <span class="mi">18</span>     <span class="c1">#   number of atoms in histdine (HIP)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ix</span><span class="p">:(</span><span class="n">ix</span><span class="o">+</span><span class="n">H_length</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;resname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">HIP</span>

                    <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="n">ix</span><span class="p">:(</span><span class="n">ix</span><span class="o">+</span><span class="n">H_length</span><span class="p">)]</span> <span class="o">==</span> <span class="s1">&#39;HE2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ix</span><span class="p">:(</span><span class="n">ix</span><span class="o">+</span><span class="n">H_length</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;resname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">HIE</span>

                    <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="n">ix</span><span class="p">:(</span><span class="n">ix</span><span class="o">+</span><span class="n">H_length</span><span class="p">)]</span> <span class="o">==</span> <span class="s1">&#39;HD1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ix</span><span class="p">:(</span><span class="n">ix</span><span class="o">+</span><span class="n">H_length</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;resname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">HID</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="n">ix</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">][</span><span class="n">ix</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NHIS&#39;</span><span class="p">:</span>
                    <span class="n">H_length</span> <span class="o">=</span> <span class="mi">19</span>

                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="n">ix</span><span class="p">:(</span><span class="n">ix</span><span class="o">+</span><span class="n">H_length</span><span class="p">)]</span> <span class="o">==</span> <span class="s1">&#39;HE2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="n">ix</span><span class="p">:(</span><span class="n">ix</span><span class="o">+</span><span class="n">H_length</span><span class="p">)]</span> <span class="o">==</span> <span class="s1">&#39;HD1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span> <span class="c1"># If the residue contains HE2 and HD1, it is a HIP residue</span>
                        <span class="n">H_length</span> <span class="o">=</span> <span class="mi">20</span>     <span class="c1">#   number of atoms in histdine (HIP)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ix</span><span class="p">:(</span><span class="n">ix</span><span class="o">+</span><span class="n">H_length</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;resname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NHIP</span>

                    <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="n">ix</span><span class="p">:(</span><span class="n">ix</span><span class="o">+</span><span class="n">H_length</span><span class="p">)]</span> <span class="o">==</span> <span class="s1">&#39;HE2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ix</span><span class="p">:(</span><span class="n">ix</span><span class="o">+</span><span class="n">H_length</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;resname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NHIE</span>

                    <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="n">ix</span><span class="p">:(</span><span class="n">ix</span><span class="o">+</span><span class="n">H_length</span><span class="p">)]</span> <span class="o">==</span> <span class="s1">&#39;HD1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ix</span><span class="p">:(</span><span class="n">ix</span><span class="o">+</span><span class="n">H_length</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;resname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NHID</span>

        <span class="c1"># Move through each line in the pdb.data file and find the corresponding charge / vdw radius as supplied by the forcefield</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">resnames</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">]):</span>
            <span class="n">values_res</span> <span class="o">=</span> <span class="n">pqr_data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">resnames</span> 
            <span class="n">values_name</span> <span class="o">=</span> <span class="n">pqr_data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">values_res</span><span class="p">,</span> <span class="n">values_name</span><span class="p">)</span>
            <span class="n">value_loc</span> <span class="o">=</span> <span class="n">pqr_data</span><span class="p">[</span><span class="n">values</span><span class="p">]</span>
      
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value_loc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">value_loc</span><span class="p">,</span> <span class="n">resnames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resname&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;resid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: The atom names in your PDB file do not match the PQR file&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">charges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value_loc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;charge&quot;</span><span class="p">]))</span>
                <span class="n">radius</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value_loc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;radius&quot;</span><span class="p">]))</span>
                <span class="n">atomtypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value_loc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;atomtype&quot;</span><span class="p">])</span> 
        
        <span class="c1"># Drop the beta factor / occupancy data to be replaced with charge / vdw radius numbers    </span>
        <span class="n">pqr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;atomtype&#39;</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="s1">&#39;charge&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#  remove obselete data</span>
        <span class="n">pqr</span><span class="p">[</span><span class="s1">&#39;atomtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomtypes</span>  <span class="c1"># Replace with Amber derived data for each atom</span>
        <span class="n">pqr</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span>
        <span class="n">pqr</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">charges</span>
    
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Conversion Complete&quot;</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">pqr</span></div>
    
<div class="viewcode-block" id="Molecule.write_pqr"><a class="viewcode-back" href="../structure.html#molecule.Molecule.write_pqr">[docs]</a>    <span class="k">def</span> <span class="nf">write_pqr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">conformations</span><span class="o">=</span><span class="p">[],</span> <span class="n">index</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        overload superclass method for writing (multi)pqr.</span>

<span class="sd">        :param outname: name of pqr file to be generated.</span>
<span class="sd">        :param index: indices of atoms to write to file. If empty, all atoms are returned. Index values obtaineable with a call like: index=molecule.atomselect(&quot;A&quot;, [1, 2, 3], &quot;CA&quot;, True)[1]</span>
<span class="sd">        :param conformations: list of conformation indices to write to file. By default, a multipdb with all conformations will be produced.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># store current frame, so it will be reestablished after file output is</span>
        <span class="c1"># complete</span>
        <span class="n">currentbkp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span>
        
        <span class="c1"># if a subset of all available frames is requested to be written,</span>
        <span class="c1"># select them first</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conformations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">frames</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">conformations</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">):</span>
                <span class="n">frames</span> <span class="o">=</span> <span class="n">conformations</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ERROR: requested coordinate index </span><span class="si">%s</span><span class="s2">, but only </span><span class="si">%s</span><span class="s2"> are available&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">conformations</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)))</span>

        <span class="c1"># Get our PQR database style</span>
        <span class="n">pqr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdb2pqr</span><span class="p">()</span>

        <span class="n">f_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
            <span class="c1"># get all informations from PDB (for current conformation) in a list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_current</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pdb_data</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            
            <span class="c1"># Get our </span>
            
            
            <span class="c1"># Build our hexidecimal array if num. of atoms &gt; 99999</span>
            <span class="n">idx_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">99999</span><span class="p">:</span>
                <span class="n">vhex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="nb">hex</span><span class="p">)</span>
                <span class="n">idx_val</span> <span class="o">=</span> <span class="n">vhex</span><span class="p">(</span><span class="n">idx_val</span><span class="p">)</span>   <span class="c1"># convert index values to hexidecimal</span>
                <span class="n">idx_val</span> <span class="o">=</span> <span class="p">[</span><span class="n">num</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">idx_val</span><span class="p">]</span>  <span class="c1"># remove 0x at start of hexidecimal number</span>
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># create and write PDB line</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">L</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%-6s%5s</span><span class="s1"> </span><span class="si">%-5s%-4s%1s%4s</span><span class="s1">    </span><span class="si">%8.3f%8.3f%8.3f%7.4f%7.4f</span><span class="s1">        </span><span class="si">%2s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx_val</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">6</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">7</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">8</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">pqr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;charge&quot;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">pqr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;radius&quot;</span><span class="p">]),</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">11</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">L</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%-6s%5s</span><span class="s1">  </span><span class="si">%-4s%-4s%1s%4s</span><span class="s1">    </span><span class="si">%8.3f%8.3f%8.3f%7.4f%7.4f</span><span class="s1">        </span><span class="si">%2s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx_val</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">6</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">7</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">8</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">pqr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;charge&quot;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">pqr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;radius&quot;</span><span class="p">]),</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">11</span><span class="p">])</span>
                <span class="n">f_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>

            <span class="n">f_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;END</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">f_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_current</span><span class="p">(</span><span class="n">currentbkp</span><span class="p">)</span>

        <span class="k">return</span></div>
    
<div class="viewcode-block" id="Molecule.get_dipole_map"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_dipole_map">[docs]</a>    <span class="k">def</span> <span class="nf">get_dipole_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">pqr</span><span class="p">,</span> <span class="n">time_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">time_end</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="n">resolution</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">vox_in_window</span> <span class="o">=</span> <span class="mf">3.</span><span class="p">,</span> <span class="n">write_dipole_map</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;dipole_map.tcl&quot;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Method for generating dipole maps to be used for electron density map generation. Also prints a dipole map as a result (and if desired). It calls a cython code in lib.</span>

<span class="sd">        :param orig: Origin points for voxel grid</span>
<span class="sd">        :param pqr: PQR file for self. Can be generated by calling pdb2pqr above</span>
<span class="sd">        :param time_start: First frame to parse in multipdb</span>
<span class="sd">        :param time_end: Last frame to parse in multipdb</span>
<span class="sd">        :param resolution: Desired resolution of voxel</span>
<span class="sd">        :param vox_in_window: Amount of surrounding space to contribute to local dipole. vox_in_window * resolution gives window size (in Ang.)</span>
<span class="sd">        :param write_dipole_map: Write a dipole map in TCL format to be read in via VMD.</span>
<span class="sd">        :param fname: Name of desired dipole map to be written</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">charges</span> <span class="o">=</span> <span class="n">pqr</span><span class="p">[</span><span class="s2">&quot;charge&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span>

        <span class="n">crd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">time_start</span><span class="p">:</span><span class="n">time_end</span><span class="p">]</span> <span class="c1"># cut out coordinates we&#39;re interested in </span>
 
        <span class="n">time_end</span> <span class="o">-=</span> <span class="n">time_start</span> <span class="c1"># shift to compensate for cutting the coordinates earlier</span>
        <span class="n">time_start</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">dipole_map</span> <span class="o">=</span> <span class="n">e_density</span><span class="o">.</span><span class="n">c_get_dipole_map</span><span class="p">(</span><span class="n">crd</span> <span class="o">=</span> <span class="n">crd</span><span class="p">,</span> <span class="n">orig</span> <span class="o">=</span> <span class="n">orig</span><span class="p">,</span> <span class="n">charges</span> <span class="o">=</span> <span class="n">charges</span><span class="p">,</span> <span class="n">time_start</span> <span class="o">=</span> <span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span> <span class="o">=</span> <span class="n">time_end</span><span class="p">,</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">vox_in_window</span> <span class="o">=</span> <span class="n">vox_in_window</span><span class="p">,</span> <span class="n">write_dipole_map</span> <span class="o">=</span> <span class="n">write_dipole_map</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dipole_map</span></div>

<div class="viewcode-block" id="Molecule.get_dipole_density"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_dipole_density">[docs]</a>    <span class="k">def</span> <span class="nf">get_dipole_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dipole_map</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">min_val</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">vox_in_window</span> <span class="o">=</span> <span class="mf">3.</span><span class="p">,</span> <span class="n">eqn</span> <span class="o">=</span> <span class="s1">&#39;gauss&#39;</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="mf">310.15</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="mf">101.</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">epsilonE</span> <span class="o">=</span> <span class="mf">54.</span><span class="p">,</span> <span class="n">resolution</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Method to generate an electron density map based on a voxel grid of dipole vectors</span>

<span class="sd">        :param dipole_map: The dipole map input. Can be generated with get_dipole_map above</span>
<span class="sd">        :param orig: Origin points for voxel grid</span>
<span class="sd">        :param min_val: Minimum coordinates of edge points for the voxel grid (i.e. a single x, y, z point defining the start point of the grid to match with the multipdb)</span>
<span class="sd">        :param V: Volume of a voxel (can be found by resolution**3, but left blank in case later version institute a sphere)</span>
<span class="sd">        :param outname: Name of electron density map file produced</span>
<span class="sd">        :param vox_in_window: Amount of surrounding space to contribute to local dipole. vox_in_window * resolution gives window size (in Ang.)</span>
<span class="sd">        :param eqn: Equation mode to model the electron density</span>
<span class="sd">        :param T: Temperature of MD</span>
<span class="sd">        :param P: Pressure of MD</span>
<span class="sd">        :param epsilonE: Continuum dielectric surrounding the protein</span>
<span class="sd">        :param resolution: Desired resolution of voxel</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">dummy</span> <span class="o">=</span> <span class="n">e_density</span><span class="o">.</span><span class="n">c_get_dipole_density</span><span class="p">(</span><span class="n">dipole_map</span> <span class="o">=</span> <span class="n">dipole_map</span><span class="p">,</span> <span class="n">orig</span> <span class="o">=</span> <span class="n">orig</span><span class="p">,</span> <span class="n">min_val</span> <span class="o">=</span> <span class="n">min_val</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="p">,</span> <span class="n">outname</span> <span class="o">=</span> <span class="n">outname</span><span class="p">,</span> <span class="n">vox_in_window</span> <span class="o">=</span> <span class="n">vox_in_window</span><span class="p">,</span> <span class="n">eqn</span> <span class="o">=</span> <span class="n">eqn</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">P</span><span class="p">,</span> <span class="n">epsilonE</span> <span class="o">=</span> <span class="n">epsilonE</span><span class="p">,</span> <span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">)</span></div></div>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">biobox 1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Matteo Degiacomi.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
  </body>
</html>
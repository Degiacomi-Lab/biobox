<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>molecule &#8212; biobox 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">biobox 1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for molecule</h1><div class="highlight"><pre>
<span class="c"># Copyright (c) 2014-2017 Matteo Degiacomi</span>
<span class="c">#</span>
<span class="c"># BiobOx is free software ;</span>
<span class="c"># you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation ;</span>
<span class="c"># either version 2 of the License, or (at your option) any later version.</span>
<span class="c"># BiobOx is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY ;</span>
<span class="c"># without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="c"># See the GNU General Public License for more details.</span>
<span class="c"># You should have received a copy of the GNU General Public License along with BiobOx ;</span>
<span class="c"># if not, write to the Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA.</span>
<span class="c">#</span>
<span class="c"># Author : Matteo Degiacomi, matteothomas.degiacomi@gmail.com</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">biobox.classes.structure</span> <span class="k">import</span> <span class="n">Structure</span>

<div class="viewcode-block" id="Molecule"><a class="viewcode-back" href="../structure.html#molecule.Molecule">[docs]</a><span class="k">class</span> <span class="nc">Molecule</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Subclass of :func:`Structure &lt;structure.Structure&gt;`, allows reading, manipulating and analyzing molecular structures.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">chain_names</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="s">&#39;C&#39;</span><span class="p">,</span> <span class="s">&#39;D&#39;</span><span class="p">,</span> <span class="s">&#39;E&#39;</span><span class="p">,</span> <span class="s">&#39;F&#39;</span><span class="p">,</span> <span class="s">&#39;G&#39;</span><span class="p">,</span> <span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="s">&#39;J&#39;</span><span class="p">,</span> <span class="s">&#39;K&#39;</span><span class="p">,</span> <span class="s">&#39;L&#39;</span><span class="p">,</span> <span class="s">&#39;M&#39;</span><span class="p">,</span> <span class="s">&#39;N&#39;</span><span class="p">,</span> <span class="s">&#39;O&#39;</span><span class="p">,</span> <span class="s">&#39;P&#39;</span><span class="p">,</span> <span class="s">&#39;Q&#39;</span><span class="p">,</span> <span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="s">&#39;S&#39;</span><span class="p">,</span> <span class="s">&#39;T&#39;</span><span class="p">,</span>
                   <span class="s">&#39;U&#39;</span><span class="p">,</span> <span class="s">&#39;V&#39;</span><span class="p">,</span> <span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="s">&#39;X&#39;</span><span class="p">,</span> <span class="s">&#39;Y&#39;</span><span class="p">,</span> <span class="s">&#39;Z&#39;</span><span class="p">,</span> <span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;2&#39;</span><span class="p">,</span> <span class="s">&#39;3&#39;</span><span class="p">,</span> <span class="s">&#39;4&#39;</span><span class="p">,</span> <span class="s">&#39;5&#39;</span><span class="p">,</span> <span class="s">&#39;6&#39;</span><span class="p">,</span> <span class="s">&#39;7&#39;</span><span class="p">,</span> <span class="s">&#39;8&#39;</span><span class="p">,</span> <span class="s">&#39;9&#39;</span><span class="p">,</span> <span class="s">&#39;0&#39;</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="s">&#39;d&#39;</span><span class="p">,</span>
                   <span class="s">&#39;e&#39;</span><span class="p">,</span> <span class="s">&#39;f&#39;</span><span class="p">,</span> <span class="s">&#39;g&#39;</span><span class="p">,</span> <span class="s">&#39;h&#39;</span><span class="p">,</span> <span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="s">&#39;j&#39;</span><span class="p">,</span> <span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="s">&#39;l&#39;</span><span class="p">,</span> <span class="s">&#39;m&#39;</span><span class="p">,</span> <span class="s">&#39;n&#39;</span><span class="p">,</span> <span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="s">&#39;p&#39;</span><span class="p">,</span> <span class="s">&#39;q&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="s">&#39;t&#39;</span><span class="p">,</span> <span class="s">&#39;u&#39;</span><span class="p">,</span> <span class="s">&#39;v&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="s">&#39;x&#39;</span><span class="p">,</span>
                   <span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="s">&#39;z&#39;</span><span class="p">,</span> <span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;2&#39;</span><span class="p">,</span> <span class="s">&#39;3&#39;</span><span class="p">,</span> <span class="s">&#39;4&#39;</span><span class="p">,</span> <span class="s">&#39;5&#39;</span><span class="p">,</span> <span class="s">&#39;6&#39;</span><span class="p">,</span> <span class="s">&#39;7&#39;</span><span class="p">,</span> <span class="s">&#39;8&#39;</span><span class="p">,</span> <span class="s">&#39;9&#39;</span><span class="p">,</span> <span class="s">&#39;0&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        At instantiation, properties associated to every individual atoms are stored in a pandas Dataframe self.data.</span>
<span class="sd">        The columns of the self.data have the following names:</span>
<span class="sd">        atom, index, name, resname, chain, resid, beta, occupancy, atomtype, radius, charge.</span>

<span class="sd">        self.knowledge contains a knowledge base about atoms and residues properties. Default values are:</span>

<span class="sd">        * &#39;residue_mass&#39; property stores the average mass for most common aminoacids (values from Expasy website)</span>
<span class="sd">        * &#39;atom_vdw&#39; vdw radius of common atoms</span>
<span class="sd">        * &#39;atom_mass&#39; mass of common atoms</span>

<span class="sd">        The knowledge base can be edited. For instance, to add information about residue &quot;TST&quot; mass in molecule M type: M.knowledge[&#39;mass_residue&#39;][&quot;TST&quot;]=142.42</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Molecule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]))</span>

        <span class="c"># knowledge base about atoms and residues properties (entry keys:</span>
        <span class="c"># &#39;residue_mass&#39;, &#39;atom_vdw&#39;, &#39;atom_, mass&#39; can be edited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span><span class="p">[</span><span class="s">&#39;residue_mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;ALA&quot;</span><span class="p">:</span> <span class="mf">71.0788</span><span class="p">,</span> <span class="s">&quot;ARG&quot;</span><span class="p">:</span> <span class="mf">156.1875</span><span class="p">,</span> <span class="s">&quot;ASN&quot;</span><span class="p">:</span> <span class="mf">114.1038</span><span class="p">,</span> <span class="s">&quot;ASP&quot;</span><span class="p">:</span> <span class="mf">115.0886</span><span class="p">,</span> <span class="s">&quot;CYS&quot;</span><span class="p">:</span> <span class="mf">103.1388</span><span class="p">,</span> <span class="s">&quot;CYX&quot;</span><span class="p">:</span> <span class="mf">103.1388</span><span class="p">,</span> <span class="s">&quot;GLU&quot;</span><span class="p">:</span> <span class="mf">129.1155</span><span class="p">,</span> <span class="s">&quot;GLN&quot;</span><span class="p">:</span> <span class="mf">128.1307</span><span class="p">,</span> <span class="s">&quot;GLY&quot;</span><span class="p">:</span> <span class="mf">57.0519</span><span class="p">,</span>
                                          <span class="s">&quot;HIS&quot;</span><span class="p">:</span> <span class="mf">137.1411</span><span class="p">,</span> <span class="s">&quot;HSE&quot;</span><span class="p">:</span> <span class="mf">137.1411</span><span class="p">,</span> <span class="s">&quot;HSD&quot;</span><span class="p">:</span> <span class="mf">137.1411</span><span class="p">,</span> <span class="s">&quot;HSP&quot;</span><span class="p">:</span> <span class="mf">137.1411</span><span class="p">,</span> <span class="s">&quot;HIE&quot;</span><span class="p">:</span> <span class="mf">137.1411</span><span class="p">,</span> <span class="s">&quot;HID&quot;</span><span class="p">:</span> <span class="mf">137.1411</span><span class="p">,</span> <span class="s">&quot;HIP&quot;</span><span class="p">:</span> <span class="mf">137.1411</span><span class="p">,</span> <span class="s">&quot;ILE&quot;</span><span class="p">:</span> <span class="mf">113.1594</span><span class="p">,</span> <span class="s">&quot;LEU&quot;</span><span class="p">:</span> <span class="mf">113.1594</span><span class="p">,</span>
                                          <span class="s">&quot;LYS&quot;</span><span class="p">:</span> <span class="mf">128.1741</span><span class="p">,</span> <span class="s">&quot;MET&quot;</span><span class="p">:</span> <span class="mf">131.1926</span><span class="p">,</span> <span class="s">&quot;MSE&quot;</span><span class="p">:</span> <span class="mf">131.1926</span><span class="p">,</span> <span class="s">&quot;PHE&quot;</span><span class="p">:</span> <span class="mf">147.1766</span><span class="p">,</span> <span class="s">&quot;PRO&quot;</span><span class="p">:</span> <span class="mf">97.1167</span><span class="p">,</span> <span class="s">&quot;SER&quot;</span><span class="p">:</span> <span class="mf">87.0782</span><span class="p">,</span> <span class="s">&quot;THR&quot;</span><span class="p">:</span> <span class="mf">101.1051</span><span class="p">,</span> <span class="s">&quot;TRP&quot;</span><span class="p">:</span> <span class="mf">186.2132</span><span class="p">,</span> <span class="s">&quot;TYR&quot;</span><span class="p">:</span> <span class="mf">163.1760</span><span class="p">,</span> <span class="s">&quot;VAL&quot;</span><span class="p">:</span> <span class="mf">99.1326</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span><span class="p">[</span><span class="s">&#39;atom_vdw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;H&#39;</span><span class="p">:</span> <span class="mf">1.20</span><span class="p">,</span> <span class="s">&#39;N&#39;</span><span class="p">:</span> <span class="mf">1.55</span><span class="p">,</span> <span class="s">&#39;NA&#39;</span><span class="p">:</span> <span class="mf">2.27</span><span class="p">,</span> <span class="s">&#39;CU&#39;</span><span class="p">:</span> <span class="mf">1.40</span><span class="p">,</span> <span class="s">&#39;CL&#39;</span><span class="p">:</span> <span class="mf">1.75</span><span class="p">,</span> <span class="s">&#39;C&#39;</span><span class="p">:</span> <span class="mf">1.70</span><span class="p">,</span> <span class="s">&#39;O&#39;</span><span class="p">:</span> <span class="mf">1.52</span><span class="p">,</span> <span class="s">&#39;I&#39;</span><span class="p">:</span> <span class="mf">1.98</span><span class="p">,</span> <span class="s">&#39;P&#39;</span><span class="p">:</span> <span class="mf">1.80</span><span class="p">,</span> <span class="s">&#39;B&#39;</span><span class="p">:</span> <span class="mf">1.85</span><span class="p">,</span> <span class="s">&#39;BR&#39;</span><span class="p">:</span> <span class="mf">1.85</span><span class="p">,</span> <span class="s">&#39;S&#39;</span><span class="p">:</span> <span class="mf">1.80</span><span class="p">,</span> <span class="s">&#39;SE&#39;</span><span class="p">:</span> <span class="mf">1.90</span><span class="p">,</span>
                                      <span class="s">&#39;F&#39;</span><span class="p">:</span> <span class="mf">1.47</span><span class="p">,</span> <span class="s">&#39;FE&#39;</span><span class="p">:</span> <span class="mf">1.80</span><span class="p">,</span> <span class="s">&#39;K&#39;</span><span class="p">:</span> <span class="mf">2.75</span><span class="p">,</span> <span class="s">&#39;MN&#39;</span><span class="p">:</span> <span class="mf">1.73</span><span class="p">,</span> <span class="s">&#39;MG&#39;</span><span class="p">:</span> <span class="mf">1.73</span><span class="p">,</span> <span class="s">&#39;ZN&#39;</span><span class="p">:</span> <span class="mf">1.39</span><span class="p">,</span> <span class="s">&#39;HG&#39;</span><span class="p">:</span> <span class="mf">1.8</span><span class="p">,</span> <span class="s">&#39;XE&#39;</span><span class="p">:</span> <span class="mf">1.8</span><span class="p">,</span> <span class="s">&#39;AU&#39;</span><span class="p">:</span> <span class="mf">1.8</span><span class="p">,</span> <span class="s">&#39;LI&#39;</span><span class="p">:</span> <span class="mf">1.8</span><span class="p">,</span> <span class="s">&#39;.&#39;</span><span class="p">:</span> <span class="mf">1.8</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span><span class="p">[</span><span class="s">&#39;atom_ccs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;H&#39;</span><span class="p">:</span> <span class="mf">1.2</span><span class="p">,</span> <span class="s">&#39;C&#39;</span><span class="p">:</span> <span class="mf">1.91</span><span class="p">,</span> <span class="s">&#39;N&#39;</span><span class="p">:</span> <span class="mf">1.91</span><span class="p">,</span> <span class="s">&#39;O&#39;</span><span class="p">:</span> <span class="mf">1.91</span><span class="p">,</span> <span class="s">&#39;P&#39;</span><span class="p">:</span> <span class="mf">1.91</span><span class="p">,</span> <span class="s">&#39;S&#39;</span><span class="p">:</span> <span class="mf">1.91</span><span class="p">,</span> <span class="s">&#39;.&#39;</span><span class="p">:</span> <span class="mf">1.91</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span><span class="p">[</span><span class="s">&#39;atom_mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;H&quot;</span><span class="p">:</span> <span class="mf">1.00794</span><span class="p">,</span> <span class="s">&quot;D&quot;</span><span class="p">:</span> <span class="mf">2.01410178</span><span class="p">,</span> <span class="s">&quot;HE&quot;</span><span class="p">:</span> <span class="mf">4.00</span><span class="p">,</span> <span class="s">&quot;LI&quot;</span><span class="p">:</span> <span class="mf">6.941</span><span class="p">,</span> <span class="s">&quot;BE&quot;</span><span class="p">:</span> <span class="mf">9.01</span><span class="p">,</span> <span class="s">&quot;B&quot;</span><span class="p">:</span> <span class="mf">10.811</span><span class="p">,</span> <span class="s">&quot;C&quot;</span><span class="p">:</span> <span class="mf">12.0107</span><span class="p">,</span> <span class="s">&quot;N&quot;</span><span class="p">:</span> <span class="mf">14.0067</span><span class="p">,</span> <span class="s">&quot;O&quot;</span><span class="p">:</span> <span class="mf">15.9994</span><span class="p">,</span> <span class="s">&quot;F&quot;</span><span class="p">:</span> <span class="mf">18.998403</span><span class="p">,</span> <span class="s">&quot;NE&quot;</span><span class="p">:</span> <span class="mf">20.18</span><span class="p">,</span> <span class="s">&quot;NA&quot;</span><span class="p">:</span> <span class="mf">22.989769</span><span class="p">,</span>
                                       <span class="s">&quot;MG&quot;</span><span class="p">:</span> <span class="mf">24.305</span><span class="p">,</span> <span class="s">&quot;AL&quot;</span><span class="p">:</span> <span class="mf">26.98</span><span class="p">,</span> <span class="s">&quot;SI&quot;</span><span class="p">:</span> <span class="mf">28.09</span><span class="p">,</span> <span class="s">&quot;P&quot;</span><span class="p">:</span> <span class="mf">30.973762</span><span class="p">,</span> <span class="s">&quot;S&quot;</span><span class="p">:</span> <span class="mf">32.065</span><span class="p">,</span> <span class="s">&quot;CL&quot;</span><span class="p">:</span> <span class="mf">35.453</span><span class="p">,</span> <span class="s">&quot;AR&quot;</span><span class="p">:</span> <span class="mf">39.95</span><span class="p">,</span> <span class="s">&quot;K&quot;</span><span class="p">:</span> <span class="mf">39.0983</span><span class="p">,</span> <span class="s">&quot;CA&quot;</span><span class="p">:</span> <span class="mf">40.078</span><span class="p">,</span> <span class="s">&quot;SC&quot;</span><span class="p">:</span> <span class="mf">44.96</span><span class="p">,</span> <span class="s">&quot;TI&quot;</span><span class="p">:</span> <span class="mf">47.87</span><span class="p">,</span> <span class="s">&quot;V&quot;</span><span class="p">:</span> <span class="mf">50.94</span><span class="p">,</span>
                                       <span class="s">&quot;CR&quot;</span><span class="p">:</span> <span class="mf">51.9961</span><span class="p">,</span> <span class="s">&quot;MN&quot;</span><span class="p">:</span> <span class="mf">54.938045</span><span class="p">,</span> <span class="s">&quot;FE&quot;</span><span class="p">:</span> <span class="mf">55.845</span><span class="p">,</span> <span class="s">&quot;CO&quot;</span><span class="p">:</span> <span class="mf">58.93</span><span class="p">,</span> <span class="s">&quot;NI&quot;</span><span class="p">:</span> <span class="mf">58.6934</span><span class="p">,</span> <span class="s">&quot;CU&quot;</span><span class="p">:</span> <span class="mf">63.546</span><span class="p">,</span> <span class="s">&quot;ZN&quot;</span><span class="p">:</span> <span class="mf">65.409</span><span class="p">,</span> <span class="s">&quot;GA&quot;</span><span class="p">:</span> <span class="mf">69.72</span><span class="p">,</span> <span class="s">&quot;GE&quot;</span><span class="p">:</span> <span class="mf">72.64</span><span class="p">,</span> <span class="s">&quot;AS&quot;</span><span class="p">:</span> <span class="mf">74.9216</span><span class="p">,</span> <span class="s">&quot;SE&quot;</span><span class="p">:</span> <span class="mf">78.96</span><span class="p">,</span>
                                       <span class="s">&quot;BR&quot;</span><span class="p">:</span> <span class="mf">79.90</span><span class="p">,</span> <span class="s">&quot;KR&quot;</span><span class="p">:</span> <span class="mf">83.80</span><span class="p">,</span> <span class="s">&quot;RB&quot;</span><span class="p">:</span> <span class="mf">85.47</span><span class="p">,</span> <span class="s">&quot;SR&quot;</span><span class="p">:</span> <span class="mf">87.62</span><span class="p">,</span> <span class="s">&quot;Y&quot;</span><span class="p">:</span> <span class="mf">88.91</span><span class="p">,</span> <span class="s">&quot;ZR&quot;</span><span class="p">:</span> <span class="mf">91.22</span><span class="p">,</span> <span class="s">&quot;NB&quot;</span><span class="p">:</span> <span class="mf">92.91</span><span class="p">,</span> <span class="s">&quot;MO&quot;</span><span class="p">:</span> <span class="mf">95.94</span><span class="p">,</span> <span class="s">&quot;TC&quot;</span><span class="p">:</span> <span class="mf">98.0</span><span class="p">,</span> <span class="s">&quot;RU&quot;</span><span class="p">:</span> <span class="mf">101.07</span><span class="p">,</span> <span class="s">&quot;RH&quot;</span><span class="p">:</span> <span class="mf">102.91</span><span class="p">,</span> <span class="s">&quot;PD&quot;</span><span class="p">:</span> <span class="mf">106.42</span><span class="p">,</span>
                                       <span class="s">&quot;AG&quot;</span><span class="p">:</span> <span class="mf">107.8682</span><span class="p">,</span> <span class="s">&quot;CD&quot;</span><span class="p">:</span> <span class="mf">112.411</span><span class="p">,</span> <span class="s">&quot;IN&quot;</span><span class="p">:</span> <span class="mf">114.82</span><span class="p">,</span> <span class="s">&quot;SN&quot;</span><span class="p">:</span> <span class="mf">118.71</span><span class="p">,</span> <span class="s">&quot;SB&quot;</span><span class="p">:</span> <span class="mf">121.76</span><span class="p">,</span> <span class="s">&quot;TE&quot;</span><span class="p">:</span> <span class="mf">127.60</span><span class="p">,</span> <span class="s">&quot;I&quot;</span><span class="p">:</span> <span class="mf">126.90447</span><span class="p">,</span> <span class="s">&quot;XE&quot;</span><span class="p">:</span> <span class="mf">131.29</span><span class="p">,</span> <span class="s">&quot;CS&quot;</span><span class="p">:</span> <span class="mf">132.91</span><span class="p">,</span> <span class="s">&quot;BA&quot;</span><span class="p">:</span> <span class="mf">137.33</span><span class="p">,</span> <span class="s">&quot;PR&quot;</span><span class="p">:</span> <span class="mf">140.91</span><span class="p">,</span>
                                       <span class="s">&quot;EU&quot;</span><span class="p">:</span> <span class="mf">151.96</span><span class="p">,</span> <span class="s">&quot;GD&quot;</span><span class="p">:</span> <span class="mf">157.25</span><span class="p">,</span> <span class="s">&quot;TB&quot;</span><span class="p">:</span> <span class="mf">158.93</span><span class="p">,</span> <span class="s">&quot;W&quot;</span><span class="p">:</span> <span class="mf">183.84</span><span class="p">,</span> <span class="s">&quot;IR&quot;</span><span class="p">:</span> <span class="mf">192.22</span><span class="p">,</span> <span class="s">&quot;PT&quot;</span><span class="p">:</span> <span class="mf">195.084</span><span class="p">,</span> <span class="s">&quot;AU&quot;</span><span class="p">:</span> <span class="mf">196.96657</span><span class="p">,</span> <span class="s">&quot;HG&quot;</span><span class="p">:</span> <span class="mf">200.59</span><span class="p">,</span> <span class="s">&quot;PB&quot;</span><span class="p">:</span> <span class="mf">207.2</span><span class="p">,</span> <span class="s">&quot;U&quot;</span><span class="p">:</span> <span class="mf">238.03</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span><span class="p">[</span><span class="s">&#39;atomtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;C&quot;</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;CA&quot;</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;CB&quot;</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;CG&quot;</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;CG1&quot;</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;CG2&quot;</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;CZ&quot;</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;CD1&quot;</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;CD2&quot;</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span>
                                      <span class="s">&quot;CD&quot;</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;CE&quot;</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;CE1&quot;</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;CE2&quot;</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;CE3&quot;</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;CZ2&quot;</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;CZ3&quot;</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;CH2&quot;</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span>
                                      <span class="s">&quot;N&quot;</span><span class="p">:</span> <span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="s">&quot;NH1&quot;</span><span class="p">:</span> <span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="s">&quot;NH2&quot;</span><span class="p">:</span> <span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="s">&quot;NZ&quot;</span><span class="p">:</span> <span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="s">&quot;NE&quot;</span><span class="p">:</span> <span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="s">&quot;NE1&quot;</span><span class="p">:</span> <span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="s">&quot;NE2&quot;</span><span class="p">:</span> <span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="s">&quot;ND1&quot;</span><span class="p">:</span> <span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="s">&quot;ND2&quot;</span><span class="p">:</span> <span class="s">&quot;N&quot;</span><span class="p">,</span>
                                      <span class="s">&quot;O&quot;</span><span class="p">:</span> <span class="s">&quot;O&quot;</span><span class="p">,</span> <span class="s">&quot;OG&quot;</span><span class="p">:</span> <span class="s">&quot;O&quot;</span><span class="p">,</span> <span class="s">&quot;OG1&quot;</span><span class="p">:</span> <span class="s">&quot;O&quot;</span><span class="p">,</span> <span class="s">&quot;OG2&quot;</span><span class="p">:</span> <span class="s">&quot;O&quot;</span><span class="p">,</span> <span class="s">&quot;OD1&quot;</span><span class="p">:</span> <span class="s">&quot;O&quot;</span><span class="p">,</span> <span class="s">&quot;OD2&quot;</span><span class="p">:</span> <span class="s">&quot;O&quot;</span><span class="p">,</span> <span class="s">&quot;OE1&quot;</span><span class="p">:</span> <span class="s">&quot;O&quot;</span><span class="p">,</span> <span class="s">&quot;OE2&quot;</span><span class="p">:</span> <span class="s">&quot;O&quot;</span><span class="p">,</span> <span class="s">&quot;OH&quot;</span><span class="p">:</span> <span class="s">&quot;O&quot;</span><span class="p">,</span> <span class="s">&quot;OXT&quot;</span><span class="p">:</span> <span class="s">&quot;O&quot;</span><span class="p">,</span>
                                      <span class="s">&quot;SD&quot;</span><span class="p">:</span> <span class="s">&quot;S&quot;</span><span class="p">,</span> <span class="s">&quot;SG&quot;</span><span class="p">:</span> <span class="s">&quot;S&quot;</span><span class="p">}</span>

<div class="viewcode-block" id="Molecule.know"><a class="viewcode-back" href="../structure.html#molecule.Molecule.know">[docs]</a>    <span class="k">def</span> <span class="nf">know</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        return information from knowledge base</span>

<span class="sd">        :param prop: desired property to extract from knowledge base</span>
<span class="sd">        :returns: value associated to requested property, or nan if failed</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">prop</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;entry %s not found in knowledge base!&quot;</span> <span class="o">%</span> <span class="n">prop</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.import_pdb"><a class="viewcode-back" href="../structure.html#molecule.Molecule.import_pdb">[docs]</a>    <span class="k">def</span> <span class="nf">import_pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdb</span><span class="p">,</span> <span class="n">include_hetatm</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        read a pdb (possibly containing containing multiple models).</span>

<span class="sd">        Models are split according to ENDMDL and END statement.</span>
<span class="sd">        All alternative coordinates are expected to have the same atoms.</span>
<span class="sd">        After loading, the first model (M.current_model=0) will be set as active.</span>

<span class="sd">        :param pdb: PDB filename</span>
<span class="sd">        :param include_hetatm: if True, HETATM will be included (they get skipped if False)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">f_in</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdb</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: file %s not found!&#39;</span> <span class="o">%</span> <span class="n">pdb</span><span class="p">)</span>

        <span class="c"># store filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdb</span>

        <span class="n">data_in</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">e</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">alternative</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">biomt</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">symm</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_in</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c"># load biomatrix, if any is present</span>
            <span class="k">if</span> <span class="s">&quot;REMARK 350   BIOMT&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">biomt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;ERROR: biomatrix format seems corrupted&quot;</span><span class="p">)</span>

            <span class="c"># load symmetry matrix, if any is present</span>
            <span class="k">if</span> <span class="s">&quot;REMARK 290   SMTRY&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">symm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;ERROR: symmetry matrix format seems corrupted&quot;</span><span class="p">)</span>

            <span class="c"># if a complete model was parsed store all the saved data into</span>
            <span class="c"># self.data entries (if needed) and temporary alternative</span>
            <span class="c"># coordinates list</span>
            <span class="k">if</span> <span class="n">record</span> <span class="o">==</span> <span class="s">&quot;ENDMDL&quot;</span> <span class="ow">or</span> <span class="n">record</span> <span class="o">==</span> <span class="s">&quot;END&quot;</span><span class="p">:</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                    <span class="c"># load all the parsed data in superclass data (Dataframe)</span>
                    <span class="c"># and points data structures</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c">#building dataframe</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_in</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;atom&quot;</span><span class="p">,</span> <span class="s">&quot;index&quot;</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;resname&quot;</span><span class="p">,</span> <span class="s">&quot;chain&quot;</span><span class="p">,</span> <span class="s">&quot;resid&quot;</span><span class="p">,</span> <span class="s">&quot;beta&quot;</span><span class="p">,</span> <span class="s">&quot;occupancy&quot;</span><span class="p">,</span> <span class="s">&quot;atomtype&quot;</span><span class="p">]</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: something went wrong when loading the structure %s!</span><span class="se">\n</span><span class="s">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span><span class="n">pdb</span><span class="p">)</span>

                    <span class="c"># saving vdw radii</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: something went wrong when loading the structure %s!</span><span class="se">\n</span><span class="s">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span><span class="n">pdb</span><span class="p">)</span>

                    <span class="c"># save default charge state</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

                <span class="c"># save 3D coordinates of every atom and restart the accumulator</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">alternative</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: something went wrong when loading the structure %s!</span><span class="se">\n</span><span class="s">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span> <span class="n">pdb</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">record</span> <span class="o">==</span> <span class="s">&#39;ATOM&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">include_hetatm</span> <span class="ow">and</span> <span class="n">record</span> <span class="o">==</span> <span class="s">&#39;HETATM&#39;</span><span class="p">):</span>

                <span class="c"># extract xyz coordinates (save in list of point coordinates)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">38</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">38</span><span class="p">:</span><span class="mi">46</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">46</span><span class="p">:</span><span class="mi">54</span><span class="p">])])</span>

                <span class="c"># if no complete model has been yet parsed, load also</span>
                <span class="c"># information about atoms(resid, resname, ...)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c"># extract ATOM/HETATM statement</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c"># extract atom index</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c"># extract atomname</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c"># extract resname</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c"># extract chain name</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">26</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c"># extract residue id</span>

                    <span class="c"># extract occupancy</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">54</span><span class="p">:</span><span class="mi">60</span><span class="p">]))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

                    <span class="c"># extract beta factor</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c"># w.append(&quot;{0.2f}&quot;.format(float(line[60:66])))</span>
                        <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">60</span><span class="p">:</span><span class="mi">66</span><span class="p">]))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

                    <span class="c"># extract atomtype</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">76</span><span class="p">:</span><span class="mi">78</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>

                    <span class="c"># use atomtype to extract vdw radius</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">know</span><span class="p">(</span><span class="s">&#39;atom_vdw&#39;</span><span class="p">)[</span><span class="n">line</span><span class="p">[</span><span class="mi">76</span><span class="p">:</span><span class="mi">78</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()])</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">know</span><span class="p">(</span><span class="s">&#39;atom_vdw&#39;</span><span class="p">)[</span><span class="s">&#39;.&#39;</span><span class="p">])</span>

                    <span class="c"># assign default charge state of 0</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

                    <span class="n">data_in</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="n">f_in</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># if p list is not empty, that means that the PDB file does not finish with an END statement (like the ones generated by SBT, for instance).</span>
        <span class="c"># In this case, dump all the remaining stuff into alternate coordinates</span>
        <span class="c"># array and (if needed) into properties dictionary.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c"># if no model has been yet loaded, save also information in</span>
            <span class="c"># properties dictionary.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                <span class="c"># load all the parsed data in superclass properties[&#39;data&#39;] and</span>
                <span class="c"># points data structures</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c">#building dataframe</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_in</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;atom&quot;</span><span class="p">,</span> <span class="s">&quot;index&quot;</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;resname&quot;</span><span class="p">,</span> <span class="s">&quot;chain&quot;</span><span class="p">,</span> <span class="s">&quot;resid&quot;</span><span class="p">,</span> <span class="s">&quot;beta&quot;</span><span class="p">,</span> <span class="s">&quot;occupancy&quot;</span><span class="p">,</span> <span class="s">&quot;atomtype&quot;</span><span class="p">]</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: something went wrong when saving data in %s!</span><span class="se">\n</span><span class="s">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span><span class="n">pdb</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: something went wrong when saving van der Waals radii in %s!</span><span class="se">\n</span><span class="s">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span> <span class="n">pdb</span><span class="p">)</span>

                <span class="c"># save default charge state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="c"># save 3D coordinates of every atom and restart the accumulator</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">alternative</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: something went wrong when saving coordinates in %s!</span><span class="se">\n</span><span class="s">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span><span class="n">pdb</span><span class="p">)</span>

        <span class="c"># transform the alternative temporary list into a nice multiple</span>
        <span class="c"># coordinates array</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">alternative_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">alternative_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">alternative</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="nb">print</span> <span class="s">&#39;WARNING: found %s models, but their atom count differs&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span>
                <span class="nb">print</span> <span class="s">&#39;WARNING: treating only the first model in file %s&#39;</span> <span class="o">%</span> <span class="n">pdb</span>
                <span class="c">#raise Exception(&#39;ERROR: models appear not to have the same amount of atoms&#39;)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_xyz</span><span class="p">(</span><span class="n">alternative_xyz</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: something went wrong when saving alternative coordinates in %s!</span><span class="se">\n</span><span class="s">ERROR: no model was loaded... are ENDMDL statements there?&#39;</span> <span class="o">%</span> <span class="n">pdb</span><span class="p">)</span>

        <span class="c"># if biomatrix information is provided, creat</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">biomt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c"># test whether there are enough lines to create biomatrix</span>
            <span class="c"># statements</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">biomt</span><span class="p">),</span> <span class="mi">3</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: found %s BIOMT entries. A multiple of 3 is expected&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">biomt</span><span class="p">))</span>

            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">biomt</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">biomt</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&quot;biomatrix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>

        <span class="c"># if symmetry information is provided, create entry in properties</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">symm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c"># test whether there are enough lines to create biomatrix</span>
            <span class="c"># statements</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symm</span><span class="p">),</span> <span class="mi">3</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: found %s SMTRY entries. A multiple of 3 is expected&#39;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">symm</span><span class="p">))</span>

            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">symm</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">symm</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&quot;symmetry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>

        <span class="c">#correctly set types of columns requiring other than string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;resid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;resid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;occupancy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;occupancy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span></div>


<div class="viewcode-block" id="Molecule.import_pqr"><a class="viewcode-back" href="../structure.html#molecule.Molecule.import_pqr">[docs]</a>    <span class="k">def</span> <span class="nf">import_pqr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pqr</span><span class="p">,</span> <span class="n">include_hetatm</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Read a pqr (possibly containing containing multiple models).</span>

<span class="sd">        models are split according to ENDMDL and END statement.</span>
<span class="sd">        All alternative coordinates are expected to have the same atoms.</span>
<span class="sd">        After loading, the first model (M.current_model=0) will be set as active.</span>

<span class="sd">        :param pqr: PQR filename</span>
<span class="sd">        :param include_hetatm: if True, HETATM will be included (they get skipped if False)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">f_in</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pqr</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: file %s not found!&#39;</span> <span class="o">%</span> <span class="n">pqr</span><span class="p">)</span>

        <span class="c"># store filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pqr</span>

        <span class="n">data_in</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c"># collects coordinates for every model</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c"># vdW radii</span>
        <span class="n">e</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c"># electrostatics</span>
        <span class="n">alternative</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_in</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c"># if a complete model was parsed store all the saved data into</span>
            <span class="c"># self.properties entries (if needed) and temporary alternative</span>
            <span class="c"># coordinates list</span>
            <span class="k">if</span> <span class="n">record</span> <span class="o">==</span> <span class="s">&quot;ENDMDL&quot;</span> <span class="ow">or</span> <span class="n">record</span> <span class="o">==</span> <span class="s">&quot;END&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c"># load all the parsed data in superclass properties[&#39;data&#39;]</span>
                    <span class="c"># and points data structures</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c">#building dataframe</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_in</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;atom&quot;</span><span class="p">,</span> <span class="s">&quot;index&quot;</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;resname&quot;</span><span class="p">,</span> <span class="s">&quot;chain&quot;</span><span class="p">,</span> <span class="s">&quot;resid&quot;</span><span class="p">,</span> <span class="s">&quot;beta&quot;</span><span class="p">,</span> <span class="s">&quot;occupancy&quot;</span><span class="p">,</span> <span class="s">&quot;atomtype&quot;</span><span class="p">]</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: something went wrong when loading the structure %s!</span><span class="se">\n</span><span class="s">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span><span class="n">pqr</span><span class="p">)</span>

                    <span class="c"># saving vdw radii</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: something went wrong when loading the structure %s!</span><span class="se">\n</span><span class="s">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span><span class="n">pqr</span><span class="p">)</span>

                    <span class="c"># saving electrostatics</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: something went wrong when loading the structure %s!</span><span class="se">\n</span><span class="s">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span> <span class="n">pqr</span><span class="p">)</span>

                <span class="c"># save 3D coordinates of every atom and restart the accumulator</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">alternative</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: something went wrong when loading the structure %s!</span><span class="se">\n</span><span class="s">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span><span class="n">pqr</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">record</span> <span class="o">==</span> <span class="s">&#39;ATOM&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">include_hetatm</span> <span class="ow">and</span> <span class="n">record</span> <span class="o">==</span> <span class="s">&#39;HETATM&#39;</span><span class="p">):</span>

                <span class="c"># extract xyz coordinates (save in list of point coordinates)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">38</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">38</span><span class="p">:</span><span class="mi">46</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">46</span><span class="p">:</span><span class="mi">54</span><span class="p">])])</span>

                <span class="c"># if no complete model has been yet parsed, load also</span>
                <span class="c"># information about atoms(resid, resname, ...)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                    <span class="c"># extract charge</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c"># 54 is separator, 55 is plus/minus</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">54</span><span class="p">:</span><span class="mi">62</span><span class="p">]))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

                    <span class="c"># extract vdW radius</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">62</span><span class="p">:</span><span class="mi">69</span><span class="p">]))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">know</span><span class="p">(</span><span class="s">&#39;atom_vdw&#39;</span><span class="p">)[</span><span class="s">&#39;.&#39;</span><span class="p">])</span>

                    <span class="c"># initialize list</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c"># extract ATOM/HETATM statement</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c"># extract atom index</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c"># extract atomname</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c"># extract resname</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c"># extract chain name</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">26</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c"># extract residue id</span>

                    <span class="c"># extract occupancy</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">)</span>

                    <span class="c"># extract beta factor</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;0&#39;</span><span class="p">)</span>

                    <span class="c"># extract atomtype from atomname in BMRB notation</span>
                    <span class="c"># http://www.bmrb.wisc.edu/ref_info/atom_nom.tbl</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">17</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="c"># w.append(line[76:78].strip())</span>

                    <span class="n">data_in</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="n">f_in</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># if p list is not empty, that means that the pqr file does not finish with an END statement (like the ones generated by SBT, for instance).</span>
        <span class="c"># In this case, dump all the remaining stuff into alternate coordinates</span>
        <span class="c"># array and (if needed) into properties dictionary.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c"># if no model has been yet loaded, save also information in</span>
            <span class="c"># properties dictionary.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                <span class="c"># load all the parsed data in superclass properties[&#39;data&#39;] and</span>
                <span class="c"># points data structures</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c">#building dataframe</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_in</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;atom&quot;</span><span class="p">,</span> <span class="s">&quot;index&quot;</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;resname&quot;</span><span class="p">,</span> <span class="s">&quot;chain&quot;</span><span class="p">,</span> <span class="s">&quot;resid&quot;</span><span class="p">,</span> <span class="s">&quot;beta&quot;</span><span class="p">,</span> <span class="s">&quot;occupancy&quot;</span><span class="p">,</span> <span class="s">&quot;atomtype&quot;</span><span class="p">]</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: something went wrong when saving data in %s!</span><span class="se">\n</span><span class="s">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span> <span class="n">pqr</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: something went wrong when saving van der Waals radii in %s!</span><span class="se">\n</span><span class="s">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span><span class="n">pqr</span><span class="p">)</span>

            <span class="c"># save 3D coordinates of every atom and restart the accumulator</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">alternative</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: something went wrong when saving coordinates in %s!</span><span class="se">\n</span><span class="s">ERROR: are all the columns separated?&#39;</span> <span class="o">%</span><span class="n">pqr</span><span class="p">)</span>

        <span class="c"># transform the alternative temporary list into a nice multiple</span>
        <span class="c"># coordinates array</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">alternative_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">alternative_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">alternative</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="nb">print</span> <span class="s">&#39;WARNING: found %s models, but their atom count differs&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternative</span><span class="p">)</span>
                <span class="nb">print</span> <span class="s">&#39;WARNING: treating only the first model in file %s&#39;</span> <span class="o">%</span> <span class="n">pqr</span>
                <span class="c">#raise Exception(&#39;ERROR: models appear not to have the same amount of atoms&#39;)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_xyz</span><span class="p">(</span><span class="n">alternative_xyz</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: something went wrong when saving alternative coordinates in %s!</span><span class="se">\n</span><span class="s">ERROR: no model was loaded... are ENDMDL statements there?&#39;</span> <span class="o">%</span> <span class="n">pqr</span><span class="p">)</span>

        <span class="c">#correctly set types of columns requiring other than string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;resid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;resid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;occupancy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;occupancy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.assign_atomtype"><a class="viewcode-back" href="../structure.html#molecule.Molecule.assign_atomtype">[docs]</a>    <span class="k">def</span> <span class="nf">assign_atomtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        guess atomtype from atom names</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">a_type</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span><span class="p">[</span><span class="s">&quot;atomtype&quot;</span><span class="p">][</span><span class="n">atom</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">a_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_type</span></div>

<div class="viewcode-block" id="Molecule.get_vdw_density"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_vdw_density">[docs]</a>    <span class="k">def</span> <span class="nf">get_vdw_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">kernel_half_width</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        generate density map from points based on the van der Waals readius of the atoms</span>

<span class="sd">        :param buff: Buffer used to create the boundaries of the density map</span>
<span class="sd">        :param step: Stepsize for creating the density object</span>
<span class="sd">        :param kernel_half_width: Kernel half width of the gaussian kernel, will be scaled by atom specific sigma</span>
<span class="sd">        :returns: :func:`Density &lt;density.Density&gt;` object, containing a density map</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">atomdata</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">,</span> <span class="mf">1.455</span><span class="p">,</span> <span class="mf">0.51</span><span class="p">],</span> <span class="p">[</span><span class="s">&quot;H&quot;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">0.72</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">],</span>
                    <span class="p">[</span><span class="s">&quot;O&quot;</span><span class="p">,</span> <span class="mf">1.52</span><span class="p">,</span> <span class="mf">1.15</span><span class="p">,</span> <span class="mf">0.42</span><span class="p">],</span> <span class="p">[</span><span class="s">&quot;S&quot;</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">,</span> <span class="mf">1.62</span><span class="p">,</span> <span class="mf">0.54</span><span class="p">],</span>
                    <span class="p">[</span><span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="mf">1.55</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">0.44</span><span class="p">]]</span>

        <span class="n">dens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">atomdata</span><span class="p">:</span>
            <span class="c"># select atomtype and point only to those coordinates</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">][:,</span> <span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
            <span class="c"># print self.properties[&#39;data&#39;][:, 8]</span>
            <span class="c"># if there are atoms from a certain type</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># use the standard density calculation with a atom-type</span>
                <span class="c"># specific sigma value</span>
                <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density</span><span class="p">(</span><span class="n">buff</span><span class="o">=</span><span class="n">buff</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">kernel_half_width</span><span class="o">=</span><span class="n">kernel_half_width</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="c"># export the np-array density map for summing</span>
                <span class="n">d_tmp</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">]</span>

            <span class="c"># print &#39;atom %s has a maximum density of %s, occurs %s times in the protein and the density map has a shape of %s&#39;%(d[0], np.max(d_tmp), len(pts), d_tmp.shape)</span>
            <span class="c"># print &#39;one entry in d_tmp: \n%s&#39;%d_tmp[35][27][20]</span>
            <span class="c"># print np.unravel_index(d_tmp.argmax(), d_tmp.shape)</span>
            <span class="c"># initialize the dens-list if it&#39;s empty</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dens</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">d_tmp</span><span class="p">)</span>
            <span class="c"># sum up the densities from all atom types</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dens</span> <span class="o">+=</span> <span class="n">d_tmp</span>  <span class="c"># dens is a 3d numpy array with point intensities</span>

        <span class="c"># print &#39;one entry in dens is: \n%s&#39;%dens[35][27][20]</span>

        <span class="kn">from</span> <span class="nn">biobox.classes.density</span> <span class="k">import</span> <span class="n">Density</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">Density</span><span class="p">()</span>
        <span class="n">D</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dens</span>
        <span class="n">D</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dens</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">D</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dens</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">D</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>
        <span class="n">D</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;dx&#39;</span>
        <span class="n">D</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">D</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dens</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.get_electrostatics"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_electrostatics">[docs]</a>    <span class="k">def</span> <span class="nf">get_electrostatics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">buff</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">vdw_kernel_half_width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">elect_kernel_half_width</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="n">clear_mass</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        generate electrostatics map from points</span>

<span class="sd">        :param step: size of cubic voxels, in Angstrom</span>
<span class="sd">        :param buff: padding to add at points cloud boundaries</span>
<span class="sd">        :param threshold: Threshold used for removing mass occupied space from the electron density map</span>
<span class="sd">        :param vdw_kernel_half_width: kernel half width, in voxels</span>
<span class="sd">        :param elect_kernel_half_width: kernel half width, in voxels</span>
<span class="sd">        :param chain: select chain to use, default all chains</span>
<span class="sd">        :returns: positive :func:`Density &lt;density.Density&gt;` object</span>
<span class="sd">        :returns: negative :func:`Density &lt;density.Density&gt;` object</span>
<span class="sd">        :returns: mass density object</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">pts</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># numpy array of charges [c1, c2, c3, ...]</span>
            <span class="n">charges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;charge&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: No charges associated with %s&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>

        <span class="n">charges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">charges</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">charges</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c"># numpy 2d-array of shape (:, 4): [[x, y, z, charge], [x, y, z,</span>
        <span class="c"># charge], ...]</span>
        <span class="n">c_atoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">pts</span><span class="p">,</span> <span class="n">charges</span><span class="p">))</span>

        <span class="n">k</span> <span class="o">=</span> <span class="mf">8.9875517873681764</span>  <span class="c"># Coulomb&#39;s constant in nN</span>

        <span class="c"># rectangular box boundaries</span>
        <span class="n">bnds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">buff</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">buff</span><span class="p">],</span>
                         <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">buff</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">buff</span><span class="p">],</span>
                         <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pts</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">buff</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pts</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">buff</span><span class="p">]])</span>

        <span class="n">xax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">yax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="n">zax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

        <span class="c"># create empty box</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">xax</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">yax</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">zax</span><span class="p">)))</span>

        <span class="c"># place Kronecker deltas in mesh grid -&gt; discretes point coordinates</span>
        <span class="c"># into mesh grid with an intensity of charge</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">c_atoms</span><span class="p">:</span>
            <span class="n">xpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xax</span> <span class="o">-</span> <span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">ypos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yax</span> <span class="o">-</span> <span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">zpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">zax</span> <span class="o">-</span> <span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">d</span><span class="p">[</span><span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">,</span> <span class="n">zpos</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="c"># initialize 3d kernel_box</span>
        <span class="c"># how many steps are needed to reach kernel half width in angstroms</span>
        <span class="n">l_kernel</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">elect_kernel_half_width</span> <span class="o">/</span> <span class="n">step</span>
        <span class="c"># the kernel is an empty box...</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">l_kernel</span><span class="p">,</span> <span class="n">l_kernel</span><span class="p">,</span> <span class="n">l_kernel</span><span class="p">))</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nditer</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;multi_index&#39;</span><span class="p">])</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">it</span><span class="o">.</span><span class="n">finished</span><span class="p">:</span>
            <span class="n">x_index</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c"># indices</span>
            <span class="n">y_index</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">z_index</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">x_coord</span> <span class="o">=</span> <span class="n">x_index</span> <span class="o">*</span> <span class="n">step</span> <span class="o">-</span> <span class="p">(</span><span class="n">l_kernel</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>  <span class="c"># real space coordinates</span>
            <span class="n">y_coord</span> <span class="o">=</span> <span class="n">y_index</span> <span class="o">*</span> <span class="n">step</span> <span class="o">-</span> <span class="p">(</span><span class="n">l_kernel</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">z_coord</span> <span class="o">=</span> <span class="n">z_index</span> <span class="o">*</span> <span class="n">step</span> <span class="o">-</span> <span class="p">(</span><span class="n">l_kernel</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x_coord</span> <span class="o">*</span><span class="n">x_coord</span> <span class="o">+</span> <span class="n">y_coord</span> <span class="o">*</span><span class="n">y_coord</span> <span class="o">+</span> <span class="n">z_coord</span> <span class="o">*</span><span class="n">z_coord</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">distance</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>  <span class="c"># ... where a hyperbola will be created only outside of H-vdW and inside of relevant kernel-half-width distance</span>
                <span class="n">kernel</span><span class="p">[</span><span class="n">x_index</span><span class="p">,</span> <span class="n">y_index</span><span class="p">,</span> <span class="n">z_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span> <span class="o">/</span> <span class="n">distance</span>

            <span class="n">it</span><span class="o">.</span><span class="n">iternext</span><span class="p">()</span>

        <span class="c"># convolve point mesh with 3d coulomb hyperbola</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;same&#39;</span><span class="p">)</span>

        <span class="c"># define mass-occupied space</span>
        <span class="c"># mass_density is Density-object, buff=buff makes shure that the</span>
        <span class="c"># density maps have the same dimensions</span>
        <span class="n">mass_density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vdw_density</span><span class="p">(</span>
            <span class="n">buff</span><span class="o">=</span><span class="n">buff</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">kernel_half_width</span><span class="o">=</span><span class="n">vdw_kernel_half_width</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">clear_mass</span><span class="p">:</span>
            <span class="n">d_map</span> <span class="o">=</span> <span class="n">mass_density</span><span class="o">.</span><span class="n">return_density_map</span><span class="p">()</span>

        <span class="c"># initialize counter to count the amount of removed points</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># initialize the iterator for said function</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nditer</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;multi_index&#39;</span><span class="p">])</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">it</span><span class="o">.</span><span class="n">finished</span><span class="p">:</span>
            <span class="n">x_index</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c"># indices</span>
            <span class="n">y_index</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">z_index</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">multi_index</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">x_coord</span> <span class="o">=</span> <span class="n">xax</span><span class="p">[</span><span class="n">x_index</span><span class="p">]</span>  <span class="c"># real space coordinates</span>
            <span class="n">y_coord</span> <span class="o">=</span> <span class="n">yax</span><span class="p">[</span><span class="n">y_index</span><span class="p">]</span>
            <span class="n">z_coord</span> <span class="o">=</span> <span class="n">zax</span><span class="p">[</span><span class="n">z_index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">d_map</span><span class="p">[</span><span class="n">x_index</span><span class="p">,</span> <span class="n">y_index</span><span class="p">,</span> <span class="n">z_index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">e</span><span class="p">[</span><span class="n">x_index</span><span class="p">,</span> <span class="n">y_index</span><span class="p">,</span> <span class="n">z_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">it</span><span class="o">.</span><span class="n">iternext</span><span class="p">()</span>

        <span class="nb">print</span> <span class="s">&#39;removed %s points due to van der Waals clashing&#39;</span> <span class="o">%</span> <span class="n">i</span>

        <span class="c"># split the density into two maps</span>
        <span class="n">e_pos</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">e_neg</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">e_pos</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">e_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">e_neg</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">e_neg</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># changes sign of negative array for better visualization</span>
        <span class="n">e_neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">(</span><span class="n">e_neg</span><span class="p">)</span>

        <span class="c"># prepare density data structure for both positive and negative maps at</span>
        <span class="c"># once</span>
        <span class="kn">from</span> <span class="nn">biobox.classes.density</span> <span class="k">import</span> <span class="n">Density</span>
        <span class="n">D_pos</span> <span class="o">=</span> <span class="n">Density</span><span class="p">()</span>
        <span class="n">D_neg</span> <span class="o">=</span> <span class="n">Density</span><span class="p">()</span>
        <span class="n">D_pos</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_pos</span>
        <span class="n">D_neg</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_neg</span>
        <span class="n">D_pos</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D_neg</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">D_pos</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D_neg</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">step</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">D_pos</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D_neg</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span>
        <span class="n">D_pos</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D_neg</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;dx&#39;</span>
        <span class="n">D_pos</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D_neg</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">D_pos</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">e_pos</span><span class="p">)</span>
        <span class="n">D_neg</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">e_neg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">D_pos</span><span class="p">,</span> <span class="n">D_neg</span><span class="p">,</span> <span class="n">mass_density</span></div>

    <span class="k">def</span> <span class="nf">_apply_matrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mats</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        replicate molecule according to list of transformation matrices</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">M2</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">()</span>
        <span class="n">xyzall</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># replicate original coordinates applying transformations</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mats</span><span class="p">:</span>
            <span class="n">xyz2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">+</span> <span class="n">m</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c"># translate</span>
            <span class="n">xyz2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xyz2</span><span class="p">,</span> <span class="n">m</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>  <span class="c"># rotate</span>
            <span class="n">xyzall</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">xyz2</span><span class="p">)</span>  <span class="c"># merge</span>

            <span class="c">#assign a specific name to the new chain</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">newdata</span><span class="p">[</span><span class="s">&quot;chain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_names</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">newdata</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newdata</span><span class="p">)</span>

            <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">M2</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xyzall</span><span class="p">])</span>

        <span class="c"># temporary vectorized hexadecimal maker, in case there are more than</span>
        <span class="c"># 9999 atoms</span>
        <span class="k">def</span> <span class="nf">dohex</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">hex</span><span class="p">(</span><span class="n">number</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">vhex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">dohex</span><span class="p">)</span>

        <span class="n">newdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">newdata</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">newdata</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vhex</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">M2</span>

<div class="viewcode-block" id="Molecule.apply_biomatrix"><a class="viewcode-back" href="../structure.html#molecule.Molecule.apply_biomatrix">[docs]</a>    <span class="k">def</span> <span class="nf">apply_biomatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        if biomatrix information is provided, generate a new molecule with all symmetry operators applied.</span>

<span class="sd">        :returns: new Molecule containing several copies of the current Molecule, arranged according to BIOMT statements contained in pdb, or -1 if no transformation matrix is provided</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># if no biomatrix statement is found, return with error</span>
        <span class="k">if</span> <span class="s">&quot;biomatrix&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;ERROR: no biomatrix found in pdb %s&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_matrices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&quot;biomatrix&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Molecule.apply_symmetry"><a class="viewcode-back" href="../structure.html#molecule.Molecule.apply_symmetry">[docs]</a>    <span class="k">def</span> <span class="nf">apply_symmetry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        if symmetry information is provided, generate a new molecule with all symmetry operators applied.</span>

<span class="sd">        :returns: new Molecule containing several copies of the current Molecule, arranged according to SMTRY statements contained in pdb, or -1 if no transformation matrix is provided</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># if no symmetry statement is found, return with error</span>
        <span class="k">if</span> <span class="s">&quot;symmetry&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;ERROR: no symmetry matrix found in pdb %s&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&quot;filename&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_matrices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&quot;symmetry&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Molecule.import_gro"><a class="viewcode-back" href="../structure.html#molecule.Molecule.import_gro">[docs]</a>    <span class="k">def</span> <span class="nf">import_gro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        read a gro possibly containing multiple structures.</span>

<span class="sd">        :param filename: name of .gro file to import</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;ERROR: %s not found!&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c"># print &quot;\n&gt; loading %s...&quot;%filename</span>
        <span class="n">fin</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="n">d_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">atoms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fin</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
            <span class="n">d_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">atoms</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">resnumber</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">resname</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

                <span class="c"># read data useful for indexing (guess what is missing)</span>
                <span class="n">d_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s">&quot;ATOM&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">resname</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="n">resnumber</span><span class="p">,</span> <span class="s">&quot;0.0&quot;</span><span class="p">,</span> <span class="s">&quot;0.0&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">])</span>
                <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">w</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">w</span><span class="p">[</span><span class="mi">5</span><span class="p">]])</span>
                <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c"># add one conformation (in Angstrom) and store its box size in</span>
            <span class="c"># temporary list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_xyz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

            <span class="n">line</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>  <span class="c"># attempt to get header of next frame</span>

        <span class="c"># store data information and box size for every frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>


        <span class="c">#building dataframe</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d_data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;atom&quot;</span><span class="p">,</span> <span class="s">&quot;index&quot;</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;resname&quot;</span><span class="p">,</span> <span class="s">&quot;chain&quot;</span><span class="p">,</span> <span class="s">&quot;resid&quot;</span><span class="p">,</span> <span class="s">&quot;beta&quot;</span><span class="p">,</span> <span class="s">&quot;occupancy&quot;</span><span class="p">,</span> <span class="s">&quot;atomtype&quot;</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

        <span class="c">#add additional information about van der waals radius and atoms charge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d_data</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">know</span><span class="p">(</span><span class="s">&#39;atom_vdw&#39;</span><span class="p">)[</span><span class="s">&#39;.&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d_data</span><span class="p">))</span>

        <span class="n">fin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="Molecule.get_atoms_ccs"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_atoms_ccs">[docs]</a>    <span class="k">def</span> <span class="nf">get_atoms_ccs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        return array with atomic CCS radii of every atom in molecule</span>

<span class="sd">        :returns: CCS in Angstrom^2</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="s">&quot;atom_ccs&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;atom_ccs&quot;</span><span class="p">]</span>

        <span class="n">ccs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">know</span><span class="p">(</span><span class="s">&quot;atom_ccs&quot;</span><span class="p">)[</span><span class="s">&quot;.&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">know</span><span class="p">(</span><span class="s">&quot;atom_ccs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">&quot;e&quot;</span> <span class="o">!=</span> <span class="s">&quot;.&quot;</span><span class="p">:</span>
                <span class="n">ccs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;atomtype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knowledge</span><span class="p">[</span><span class="s">&quot;atom_ccs&quot;</span><span class="p">][</span><span class="n">e</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;atom_ccs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ccs</span>

        <span class="k">return</span> <span class="n">ccs</span></div>

    
<div class="viewcode-block" id="Molecule.query"><a class="viewcode-back" href="../structure.html#molecule.Molecule.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_text</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        ## select specific atoms in a multimer un the basis of a text query.</span>

<span class="sd">        :param query_text: string selecting atoms of interest. Uses the pandas query syntax, can access all columns in the dataframe self.data.</span>
<span class="sd">        :param get_index: if set to True, returns the indices of selected atoms in self.points array (and self.data)</span>
<span class="sd">        :returns: coordinates of the selected points (in a unique array) and, if get_index is set to true, a list of their indices in subunits&#39; self.points array.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query_text</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="n">get_index</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></div>


<div class="viewcode-block" id="Molecule.atomselect"><a class="viewcode-back" href="../structure.html#molecule.Molecule.atomselect">[docs]</a>    <span class="k">def</span> <span class="nf">atomselect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">use_resname</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Select specific atoms in the protein providing chain, residue ID and atom name.</span>

<span class="sd">        :param chain: selection of a specific chain name (accepts * as wildcard). Can also be a list or numpy array of strings.</span>
<span class="sd">        :param res: residue ID of desired atoms (accepts * as wildcard). Can also be a list or numpy array of of int.</span>
<span class="sd">        :param atom: name of desired atom (accepts * as wildcard). Can also be a list or numpy array of strings.</span>
<span class="sd">        :param get_index: if set to True, returns the indices of selected atoms in self.points array (and self.properties[&#39;data&#39;])</span>
<span class="sd">        :param use_resname: if set to True, consider information in &quot;res&quot; variable as resnames, and not resids</span>
<span class="sd">        :returns: coordinates of the selected points and, if get_index is set to true, their indices in self.points array.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># chain name boolean selector</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">chain</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
                <span class="n">chain_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="k">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chain_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;chain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">chain</span>
                
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span><span class="o">.</span><span class="n">__module__</span> <span class="o">==</span> <span class="s">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="n">chain_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;chain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">chain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chain</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">chain_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">chain_query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;chain&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">chain</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;ERROR: wrong type for chain selection. Should be str, list, or numpy&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
                <span class="n">res_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="k">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">use_resname</span><span class="p">:</span>
                <span class="n">res_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;resname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">res</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;resid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">res</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">use_resname</span><span class="p">:</span>
                <span class="n">res_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;resname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;resid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">res</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">.</span><span class="n">__module__</span> <span class="o">==</span> <span class="s">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_resname</span><span class="p">:</span>
                <span class="n">res_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;resname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;resid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">use_resname</span><span class="p">:</span>
                    <span class="n">res_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">res_query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;resname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">r</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">res_query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;resid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">res</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;ERROR: wrong type for resid selection. Should be int, list, or numpy&quot;</span><span class="p">)</span>

        <span class="c"># atom name boolean selector</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">atom</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
                <span class="n">atom_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="k">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atom_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">atom</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span><span class="o">.</span><span class="n">__module__</span> <span class="o">==</span> <span class="s">&#39;numpy&#39;</span><span class="p">:</span>
            <span class="n">atom_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">atom_query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">atom_query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">atom</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;ERROR: wrong type for atom selection. Should be str, list, or numpy&quot;</span><span class="p">)</span>

        <span class="c"># slice data array and return result (colums 5 to 7 contain xyz coords)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">chain_query</span><span class="p">,</span> <span class="n">res_query</span><span class="p">),</span> <span class="n">atom_query</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">get_index</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">query</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">query</span> <span class="o">==</span> <span class="k">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">query</span><span class="p">]</span></div>

<div class="viewcode-block" id="Molecule.atomignore"><a class="viewcode-back" href="../structure.html#molecule.Molecule.atomignore">[docs]</a>    <span class="k">def</span> <span class="nf">atomignore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="k">False</span><span class="p">,</span> <span class="n">use_resname</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Select specific atoms that do not match a specific query (chain, residue ID and atom name).</span>
<span class="sd">        Useful to remove from a molecule atoms unwanted for further analysis, alternative conformations, etc...</span>

<span class="sd">        :param chain: chain name (accepts * as wildcard). Can also be a list or numpy array of strings.</span>
<span class="sd">        :param res: residue ID (accepts * as wildcard). Can also be a list or numpy array of of int.</span>
<span class="sd">        :param atom: atom name (accepts * as wildcard). Can also be a list or numpy array of strings.</span>
<span class="sd">        :param get_index: if set to True, returns the indices of atoms in self.points array (and self.properties[&#39;data&#39;])</span>
<span class="sd">        :param use_resname: if set to True, consider information in &quot;res&quot; variable as resnames, and not resids</span>
<span class="sd">        :returns: coordinates of the selected points not matching the query, if get_index is set to true, their indices in self.points array.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c">#extract indices of atoms matching the query</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="k">True</span><span class="p">,</span> <span class="n">use_resname</span><span class="o">=</span><span class="n">use_resname</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c">#invert the selection</span>
        <span class="n">idxs2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
                <span class="n">idxs2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">get_index</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">idxs2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idxs2</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">idxs2</span><span class="p">]</span></div>

<div class="viewcode-block" id="Molecule.same_residue"><a class="viewcode-back" href="../structure.html#molecule.Molecule.same_residue">[docs]</a>    <span class="k">def</span> <span class="nf">same_residue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Select atoms having the same residue and chain as a given atom (or list of atoms)</span>

<span class="sd">        :param index indices: of atoms of choice (integer of list of integers)</span>
<span class="sd">        :param get_index: if set to True, returns the indices of selected atoms in self.points array (and self.properties[&#39;data&#39;])</span>
<span class="sd">        :returns: coordinates of the selected points and, if get_index is set to true, their indices in self.points array.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>

        <span class="n">test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">D</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">l</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">D</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="n">l</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">])</span>

        <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">test</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">get_index</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pts</span><span class="p">,</span> <span class="n">idxs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pts</span></div>

<div class="viewcode-block" id="Molecule.same_residue_unique"><a class="viewcode-back" href="../structure.html#molecule.Molecule.same_residue_unique">[docs]</a>    <span class="k">def</span> <span class="nf">same_residue_unique</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="k">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Select atoms having the same residue and chain as a given atom (or list of atoms)</span>

<span class="sd">        :param index: indices of atoms of choice (integer of list of integers)</span>
<span class="sd">        :param get_index: if set to True, returns the indices of selected atoms in self.points array (and self.properties[&#39;data&#39;])</span>
<span class="sd">        :returns: coordinates of the selected points and, if get_index is set to true, their indices in self.points array.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">test</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>  <span class="c"># this should fail if index is a number</span>
            <span class="n">idlist</span> <span class="o">=</span> <span class="n">index</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">idlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">values</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idlist</span><span class="p">:</span>
            <span class="n">done</span> <span class="o">=</span> <span class="k">False</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c"># starting from same point</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">-</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="k">True</span>

                <span class="k">elif</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="ow">and</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">-</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
                        <span class="n">pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">])</span>
                        <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">-</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
                        <span class="n">pts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>
                        <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span>

                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="k">True</span>

            <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">done</span> <span class="o">=</span> <span class="k">False</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">):</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="k">True</span>

                <span class="k">elif</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="ow">and</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="n">D</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
                        <span class="n">pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">])</span>
                        <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
                        <span class="n">pts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>
                        <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span>

                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="k">True</span>

        <span class="k">if</span> <span class="n">get_index</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.get_subset"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_subset">[docs]</a>    <span class="k">def</span> <span class="nf">get_subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">conformations</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a :func:`Molecule &lt;molecule.Molecule&gt;` object containing only the selected atoms and frames</span>

<span class="sd">        :param ixds: atoms to extract</span>
<span class="sd">        :param conformations: frames to extract (by default, all)</span>
<span class="sd">        :returns: :func:`Molecule &lt;molecule.Molecule&gt;` object</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># if a subset of all available frames is requested to be written,</span>
        <span class="c"># select them first</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conformations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">frames</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">conformations</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">):</span>
                <span class="n">frames</span> <span class="o">=</span> <span class="n">conformations</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;ERROR: requested coordinate index %s, but only %s are available&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">conformations</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)))</span>

        <span class="c"># create molecule, and push created data information</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">Molecule</span><span class="p">()</span>
        <span class="n">postmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[:,</span> <span class="n">idxs</span><span class="p">]</span>
        <span class="n">M</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">postmp</span><span class="p">[</span><span class="n">frames</span><span class="p">]</span>
        <span class="n">M</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>

        <span class="n">M</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">M</span><span class="o">.</span><span class="n">points</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">M</span><span class="o">.</span><span class="n">current</span><span class="p">]</span>

        <span class="n">M</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">get_center</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">M</span></div>

<div class="viewcode-block" id="Molecule.guess_chain_split"><a class="viewcode-back" href="../structure.html#molecule.Molecule.guess_chain_split">[docs]</a>    <span class="k">def</span> <span class="nf">guess_chain_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">use_backbone</span><span class="o">=</span><span class="k">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        reassign chain name, using distance cutoff (cannot be undone).</span>
<span class="sd">        If two consecutive atoms are beyond a cutoff, a new chain is assigned.</span>

<span class="sd">        :param distance: distance cutoff distance</span>
<span class="sd">        :param use_backbone: if True, splitting will be performed considering backbone atoms (N and C), all atoms in a sequence otherwise</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># wipe current chain assignment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;chain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="c"># identify different chains</span>
        <span class="n">intervals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_backbone</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="n">distance</span><span class="p">:</span>
                    <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c">#aminoacids start with N. Find where a C is too far from the next N.</span>
            <span class="n">posN</span><span class="p">,</span> <span class="n">idxN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="k">True</span><span class="p">)</span>
            <span class="n">posC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="s">&quot;C&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idxN</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">posC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">posN</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">posC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">posN</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="n">distance</span><span class="p">:</span>
                    <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idxN</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c"># separate chains</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">thepos</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain_names</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">intervals</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">intervals</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain_names</span><span class="p">[</span><span class="n">thepos</span><span class="p">]</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="Molecule.get_pdb_data"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_pdb_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_pdb_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        aggregate data and point coordinates, and return in a unique data structure</span>

<span class="sd">        Returned data is a list containing strings for points data and floats for point coordinates</span>
<span class="sd">        in the same order as a pdb file, i.e.</span>
<span class="sd">        ATOM/HETATM, index, name, resname, chain name, residue ID, x, y, z, occupancy, beta factor, atomtype.</span>

<span class="sd">        :returns: list aggregated data and coordinates for every point, as string.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c"># create a list containing all infos contained in pdb (point</span>
        <span class="c"># coordinates and properties)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;atom&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;index&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;resname&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;chain&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;resid&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;beta&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;occupancy&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;atomtype&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span>

        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="Molecule.write_pdb"><a class="viewcode-back" href="../structure.html#molecule.Molecule.write_pdb">[docs]</a>    <span class="k">def</span> <span class="nf">write_pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">conformations</span><span class="o">=</span><span class="p">[],</span> <span class="n">index</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        overload superclass method for writing (multi)pdb.</span>

<span class="sd">        :param outname: name of pdb file to be generated.</span>
<span class="sd">        :param index: indices of atoms to write to file. If empty, all atoms are returned. Index values obtaineable with a call like: index=molecule.atomselect(&quot;A&quot;, [1, 2, 3], &quot;CA&quot;, True)[1]</span>
<span class="sd">        :param conformations: list of conformation indices to write to file. By default, a multipdb with all conformations will be produced.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># store current frame, so it will be reestablished after file output is</span>
        <span class="c"># complete</span>
        <span class="n">currentbkp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span>

        <span class="c"># if a subset of all available frames is requested to be written,</span>
        <span class="c"># select them first</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conformations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">frames</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">conformations</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">):</span>
                <span class="n">frames</span> <span class="o">=</span> <span class="n">conformations</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;ERROR: requested coordinate index %s, but only %s are available&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">conformations</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)))</span>

        <span class="n">f_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>

            <span class="c"># get all informations from PDB (for current conformation) in a</span>
            <span class="c"># list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_current</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pdb_data</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c"># create and write PDB line</span>
                <span class="n">L</span> <span class="o">=</span> <span class="s">&#39;%-6s%5s  %-4s%-4s%1s%4s    %8.3f%8.3f%8.3f%6.2f%6.2f          %2s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">6</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">7</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">8</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">9</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">10</span><span class="p">]),</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">11</span><span class="p">])</span>
                <span class="n">f_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>

            <span class="n">f_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;END</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="n">f_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_current</span><span class="p">(</span><span class="n">currentbkp</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Molecule.write_gro"><a class="viewcode-back" href="../structure.html#molecule.Molecule.write_gro">[docs]</a>    <span class="k">def</span> <span class="nf">write_gro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">conformations</span><span class="o">=</span><span class="p">[],</span> <span class="n">index</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        write structure(s) in .gro format.</span>

<span class="sd">        :param outname: name of .gro file to be generated.</span>
<span class="sd">        :param index: indices of atoms to write to file. If empty, all atoms are returned. Index values obtaineable with a call like: index=molecule.atomselect(&quot;A&quot;, [1, 2, 3], &quot;CA&quot;, True)[1]</span>
<span class="sd">        :param conformations: list of conformation indices to write to file. By default, all conformations will be returned.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># store current frame, so it will be reestablished after file output is</span>
        <span class="c"># complete</span>
        <span class="n">currentbkp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span>

        <span class="c"># if a subset of all available frames is requested to be written,</span>
        <span class="c"># select them first</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conformations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">frames</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">conformations</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">):</span>
                <span class="n">frames</span> <span class="o">=</span> <span class="n">conformations</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;ERROR: requested coordinate index %s, but only %s are available&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">conformations</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)))</span>

        <span class="n">f_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
            <span class="n">f_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">outname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">f_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">))</span>
            <span class="c"># get all informations from PDB (for current conformation) in a</span>
            <span class="c"># list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_current</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="c"># ATOM/HETATM, index, atom name, resname, chain name, residue ID, x,</span>
            <span class="c"># y, z, beta factor, occupancy, atomtype</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pdb_data</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c"># create and write .gro line</span>
                <span class="n">L</span> <span class="o">=</span> <span class="s">&#39;%5d%-5s%5s%5d%8.3f%8.3f%8.3f</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">6</span><span class="p">])</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">7</span><span class="p">])</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">8</span><span class="p">])</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">)</span>
                <span class="n">f_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>

            <span class="k">if</span> <span class="s">&quot;box&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&quot;box&quot;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">/</span> <span class="mf">10.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">minpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">minpos</span> <span class="o">/</span> <span class="mf">10.0</span>

            <span class="n">f_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;%10.5f%10.5f%10.5f</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

        <span class="n">f_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_current</span><span class="p">(</span><span class="n">currentbkp</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Molecule.beta_factor_from_rmsf"><a class="viewcode-back" href="../structure.html#molecule.Molecule.beta_factor_from_rmsf">[docs]</a>    <span class="k">def</span> <span class="nf">beta_factor_from_rmsf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        estimate atoms beta factor on the base of their RMSF.</span>

<span class="sd">        :param indices: indices of atoms of interest. If not set all atoms will be considered.</span>
<span class="sd">        :param step: timestep between two conformations (useful when using conformations extracted from molecular dynamics)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">rmsf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmsf</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
            <span class="k">return</span> <span class="mf">8.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rmsf</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: could not calculate RMSF!&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.rmsf_from_beta_factor"><a class="viewcode-back" href="../structure.html#molecule.Molecule.rmsf_from_beta_factor">[docs]</a>    <span class="k">def</span> <span class="nf">rmsf_from_beta_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        calculate RMSF from atoms beta factors.</span>

<span class="sd">        :param indices: indices of atoms of interest. If not set all atoms will be considered.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;beta&quot;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;ERROR: beta factors missing?&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Molecule.get_mass_by_residue"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_mass_by_residue">[docs]</a>    <span class="k">def</span> <span class="nf">get_mass_by_residue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_resname</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute protein mass using residues (i.e. account also for atoms not present in the structure)</span>

<span class="sd">        Sum the average mass all every residue (using a knowledge base of atom masses in Dalton)</span>
<span class="sd">        The knowledge base can be expanded or edited by adding entries to the molecule&#39;s mass dictionary, e.g. to add the residue &quot;TST&quot; mass in molecule M type: M.knowledge[&#39;mass_residue&#39;][&quot;TST&quot;]=142.42</span>

<span class="sd">        :param skip_resname: list of resnames to skip. Useful to exclude ions water or other ligands from the calculation.</span>
<span class="sd">        :returns: mass of molecule in Dalton</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c">#@todo mass of N and C termini to add for every chain</span>

        <span class="n">mass</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">chains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;chain&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">chainname</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
            <span class="c"># for every chain, get a list of all its (unique) resids</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="n">chainname</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="k">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">resids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;resid&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">resids</span><span class="p">:</span>
                <span class="c"># for every residue in the chain, get the index of its first</span>
                <span class="c"># atom, and extract its associated resname</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="n">chainname</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="k">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">resname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">resname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip_resname</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c"># add mass of residue to total mass</span>
                        <span class="n">mass</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">know</span><span class="p">(</span><span class="s">&#39;residue_mass&#39;</span><span class="p">)[</span><span class="n">resname</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="c">#@todo: if residue is not known, why not summing constituent atoms masses, warning the user that it&#39;s an estimation?</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;ERROR: mass for resname %s is unknown!</span><span class="se">\n</span><span class="s">Insert a key in protein</span><span class="se">\&#39;</span><span class="s">s masses dictionary knowledge[&#39;residue_mass&#39;] and retry!</span><span class="se">\n</span><span class="s">ex.: protein.knowledge[&#39;residue_mass&#39;][</span><span class="se">\&quot;</span><span class="s">TST</span><span class="se">\&quot;</span><span class="s">]=142.42&quot;</span> <span class="o">%</span><span class="n">resname</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mass</span></div>

<div class="viewcode-block" id="Molecule.get_mass_by_atom"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_mass_by_atom">[docs]</a>    <span class="k">def</span> <span class="nf">get_mass_by_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_resname</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        compute protein mass using atoms in pdb</span>

<span class="sd">        sum the mass of all atoms (using a knowledge base of atom masses in Dalton)</span>
<span class="sd">        The knowledge base can be expanded or edited by adding or editing entries to the molecule&#39;s mass dictionary, e.g. to add the atom &quot;PI&quot; mass in molecule M type: M.knowledge[&#39;atom_mass&#39;][&quot;PI&quot;]=3.141592</span>

<span class="sd">        :param skip_resname: list of resnames to skip. Useful to exclude ions water or other ligands from the calculation.</span>
<span class="sd">        :returns: mass of molecule in Dalton</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">mass</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">resname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;resname&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">atomtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;atomtype&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">resname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip_resname</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mass</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">know</span><span class="p">(</span><span class="s">&#39;atom_mass&#39;</span><span class="p">)[</span><span class="n">atomtype</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">atomtype</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;ERROR: no atomtype found!&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;ERROR: mass for atom %s is unknown!</span><span class="se">\n</span><span class="s">Insert a key in protein</span><span class="se">\&#39;</span><span class="s">s masses dictionary knowledge[&#39;atom_mass&#39;] and retry!</span><span class="se">\n</span><span class="s">ex.: protein.knowledge[&#39;atom_mass&#39;][</span><span class="se">\&quot;</span><span class="s">PI</span><span class="se">\&quot;</span><span class="s">]=3.141592&quot;</span> <span class="o">%</span><span class="n">atomtype</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mass</span></div>

<div class="viewcode-block" id="Molecule.s2"><a class="viewcode-back" href="../structure.html#molecule.Molecule.s2">[docs]</a>    <span class="k">def</span> <span class="nf">s2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atomname1</span><span class="o">=</span><span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="n">atomname2</span><span class="o">=</span><span class="s">&quot;H&quot;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        compute s2, given two atoms defining the vector of interest.</span>

<span class="sd">        :param atomname1: name of the first atom</span>
<span class="sd">        :param atomname2: name of the second atom</span>
<span class="sd">        :returns: data numpy array containing information about residues for which measuring has been performed (i.e.[chain, resid])</span>
<span class="sd">        :returns: s2 s2 of residues for which both provided input atoms have been found</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">Nidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">atomname1</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="k">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Hidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomselect</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">atomname2</span><span class="p">,</span> <span class="n">get_index</span><span class="o">=</span><span class="k">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Nidx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;ERROR: no atom name %s found!&quot;</span><span class="o">%</span><span class="n">atomname1</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Hidx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;ERROR: no atom name %s found!&quot;</span><span class="o">%</span><span class="n">atomname2</span><span class="p">)</span>

        <span class="n">Ndata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">Nidx</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;chain&quot;</span><span class="p">,</span> <span class="s">&quot;resid&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">Hdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">Hidx</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;chain&quot;</span><span class="p">,</span> <span class="s">&quot;resid&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

        <span class="nb">print</span> <span class="n">Ndata</span>

        <span class="n">a1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ndata</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">Hdata</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">Ndata</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="n">Hdata</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">Ndata</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">idx1</span> <span class="o">=</span> <span class="n">Nidx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">idx2</span> <span class="o">=</span> <span class="n">Hidx</span><span class="p">[</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">a1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[:,</span> <span class="n">idx1</span><span class="p">])</span>
                <span class="n">a2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[:,</span> <span class="n">idx2</span><span class="p">])</span>
                <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ndata</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">atoms1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
        <span class="n">atoms2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="c"># iterate over every residue</span>
        <span class="n">s2_summary</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

            <span class="n">dx</span> <span class="o">=</span> <span class="n">atoms2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">atoms1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">atoms2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">atoms1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="n">atoms2</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">atoms1</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span>

            <span class="c"># create list of unit vectors</span>
            <span class="n">dnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">dx</span> <span class="o">/=</span> <span class="n">dnorm</span>
            <span class="n">dy</span> <span class="o">/=</span> <span class="n">dnorm</span>
            <span class="n">dz</span> <span class="o">/=</span> <span class="n">dnorm</span>

            <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span> <span class="o">/</span> <span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span> <span class="o">/</span> <span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dz</span><span class="p">)</span> <span class="o">/</span> <span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span> <span class="o">/</span> <span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span> <span class="o">/</span> <span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">dz</span><span class="p">)</span> <span class="o">/</span> <span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dz</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span> <span class="o">/</span> <span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dz</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span> <span class="o">/</span> <span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">d</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dz</span> <span class="o">*</span> <span class="n">dz</span><span class="p">)</span> <span class="o">/</span> <span class="n">atoms1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>

            <span class="n">s2_summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">s2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s2_summary</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">s2</span></div>

<div class="viewcode-block" id="Molecule.get_couples"><a class="viewcode-back" href="../structure.html#molecule.Molecule.get_couples">[docs]</a>    <span class="k">def</span> <span class="nf">get_couples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        given a list of indices, compute the all-vs-all distance and return only couples below a given cutoff distance</span>

<span class="sd">        useful for the detection of disulfide bridges or linkable sites via cross-linking (approximation, supposing euclidean distances)&#39;</span>

<span class="sd">        :param idx: indices of atoms to check.</span>
<span class="sd">        :param cutoff: minimal distance to consider a couple as linkable.</span>
<span class="sd">        :returns: nx3 numpy array containing, for every valid connection, id of first atom, id of second atom and distance between the two.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="kn">import</span> <span class="nn">biobox.measures.interaction</span> <span class="k">as</span> <span class="nn">I</span>

        <span class="n">points1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">distance_matrix</span><span class="p">(</span><span class="n">points1</span><span class="p">,</span> <span class="n">points1</span><span class="p">)</span>
        <span class="n">couples</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">get_neighbors</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">couples</span><span class="o">.</span><span class="n">transpose</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">idx</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">idx</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dist</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]]])</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">biobox 1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Matteo Degiacomi.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
  </body>
</html>